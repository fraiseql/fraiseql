# Docker Compose for Topology 1: PostgreSQL-Only
# =================================================
#
# Simple deployment with PostgreSQL LISTEN/NOTIFY.
# No Redis, no NATS, no additional infrastructure.
#
# Best for:
# - Development/testing
# - Single database
# - Low event volume (<1000 events/sec)
# - Simple deployment requirements
#
# Usage:
#   docker-compose -f docker-compose.postgres-only.yml up

version: '3.8'

services:
  # PostgreSQL database with observer triggers
  postgres:
    image: postgres:16-alpine
    container_name: fraiseql-postgres
    environment:
      POSTGRES_DB: fraiseql
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # Mount SQL migrations
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Observer worker (PostgreSQL LISTEN/NOTIFY)
  observer:
    image: fraiseql-observer:latest
    container_name: fraiseql-observer
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database connection
      DATABASE_URL: postgresql://fraiseql:changeme@postgres:5432/fraiseql

      # Transport (PostgreSQL LISTEN/NOTIFY)
      FRAISEQL_OBSERVER_TRANSPORT: postgres

      # Performance features (all disabled without Redis)
      FRAISEQL_ENABLE_DEDUP: "false"
      FRAISEQL_ENABLE_CACHING: "false"
      FRAISEQL_ENABLE_CONCURRENT: "true"
      FRAISEQL_MAX_CONCURRENT_ACTIONS: "10"

      # Runtime settings
      FRAISEQL_CHANNEL_CAPACITY: "1000"
      FRAISEQL_MAX_CONCURRENCY: "50"
      FRAISEQL_SHUTDOWN_TIMEOUT: "30s"

      # Logging
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      # Mount configuration
      - ./examples/01-postgresql-only.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local

# Health check commands:
# docker-compose -f docker-compose.postgres-only.yml ps
# docker-compose -f docker-compose.postgres-only.yml logs observer
#
# Stop gracefully:
# docker-compose -f docker-compose.postgres-only.yml down
#
# Clean restart:
# docker-compose -f docker-compose.postgres-only.yml down -v
# docker-compose -f docker-compose.postgres-only.yml up
