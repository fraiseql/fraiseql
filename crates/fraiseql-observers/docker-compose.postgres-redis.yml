# Docker Compose for Topology 2: PostgreSQL + Redis
# ===================================================
#
# PostgreSQL LISTEN/NOTIFY + Redis for deduplication and caching.
# Best for single database with reliability and performance requirements.
#
# Features:
# - Event deduplication (at-least-once delivery guarantee)
# - Action result caching (100x performance improvement)
# - Concurrent action execution
#
# Best for:
# - Production single database
# - Medium event volume (1000-10000 events/sec)
# - Needs reliability (deduplication)
# - Needs performance (caching)
#
# Usage:
#   docker-compose -f docker-compose.postgres-redis.yml up

version: '3.8'

services:
  # PostgreSQL database with observer triggers
  postgres:
    image: postgres:16-alpine
    container_name: fraiseql-postgres
    environment:
      POSTGRES_DB: fraiseql
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for deduplication and caching
  redis:
    image: redis:7-alpine
    container_name: fraiseql-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Observer worker (PostgreSQL + Redis)
  observer:
    image: fraiseql-observer:latest
    container_name: fraiseql-observer
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database connection
      DATABASE_URL: postgresql://fraiseql:changeme@postgres:5432/fraiseql

      # Transport (PostgreSQL LISTEN/NOTIFY)
      FRAISEQL_OBSERVER_TRANSPORT: postgres

      # Redis configuration
      FRAISEQL_REDIS_URL: redis://redis:6379
      FRAISEQL_REDIS_POOL_SIZE: "10"
      FRAISEQL_REDIS_CONNECT_TIMEOUT_SECS: "5"
      FRAISEQL_REDIS_COMMAND_TIMEOUT_SECS: "2"
      FRAISEQL_REDIS_DEDUP_WINDOW_SECS: "300"     # 5 minutes
      FRAISEQL_REDIS_CACHE_TTL_SECS: "60"         # 1 minute

      # Performance features (Redis-backed)
      FRAISEQL_ENABLE_DEDUP: "true"               # ✅ Event deduplication
      FRAISEQL_ENABLE_CACHING: "true"             # ✅ Action result caching
      FRAISEQL_ENABLE_CONCURRENT: "true"          # ✅ Concurrent execution
      FRAISEQL_MAX_CONCURRENT_ACTIONS: "10"

      # Runtime settings
      FRAISEQL_CHANNEL_CAPACITY: "1000"
      FRAISEQL_MAX_CONCURRENCY: "50"
      FRAISEQL_SHUTDOWN_TIMEOUT: "30s"

      # Logging
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/02-postgresql-redis.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local

# Monitoring commands:
# docker-compose -f docker-compose.postgres-redis.yml ps
# docker-compose -f docker-compose.postgres-redis.yml logs -f observer
#
# Check Redis keys:
# docker-compose -f docker-compose.postgres-redis.yml exec redis redis-cli KEYS "event:*"
# docker-compose -f docker-compose.postgres-redis.yml exec redis redis-cli KEYS "action_result:*"
#
# Monitor Redis memory:
# docker-compose -f docker-compose.postgres-redis.yml exec redis redis-cli INFO memory
#
# Stop gracefully:
# docker-compose -f docker-compose.postgres-redis.yml down
#
# Clean restart (clears Redis):
# docker-compose -f docker-compose.postgres-redis.yml down -v
# docker-compose -f docker-compose.postgres-redis.yml up
