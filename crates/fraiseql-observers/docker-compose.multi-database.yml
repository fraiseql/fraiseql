# Docker Compose for Topology 4: Multi-Database
# =================================================
#
# Multiple PostgreSQL databases → Bridges → NATS → Shared Workers
# Centralized event bus for multi-tenant or multi-database systems.
#
# Architecture:
#   Database 1 → Bridge 1 ┐
#   Database 2 → Bridge 2 ├→ NATS → Worker Pool (with Redis)
#   Database 3 → Bridge 3 ┘
#
# Features:
# - Multiple independent databases
# - Centralized event processing
# - Shared worker pool (efficient resource usage)
# - Independent bridge failures (fault isolation)
# - Horizontal scaling of workers
#
# Best for:
# - Multi-tenant SaaS applications
# - Microservices with separate databases
# - Enterprise with multiple business units
# - Geographic distribution (databases in different regions)
#
# Usage:
#   docker-compose -f docker-compose.multi-database.yml up
#   docker-compose -f docker-compose.multi-database.yml up --scale worker=10

version: '3.8'

services:
  # ============================================================================
  # Database 1 (Tenant A / Business Unit 1)
  # ============================================================================
  postgres-db1:
    image: postgres:16-alpine
    container_name: fraiseql-postgres-db1
    environment:
      POSTGRES_DB: fraiseql_db1
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"
    volumes:
      - postgres-db1-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Database 2 (Tenant B / Business Unit 2)
  # ============================================================================
  postgres-db2:
    image: postgres:16-alpine
    container_name: fraiseql-postgres-db2
    environment:
      POSTGRES_DB: fraiseql_db2
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5433:5432"
    volumes:
      - postgres-db2-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Database 3 (Tenant C / Business Unit 3)
  # ============================================================================
  postgres-db3:
    image: postgres:16-alpine
    container_name: fraiseql-postgres-db3
    environment:
      POSTGRES_DB: fraiseql_db3
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5434:5432"
    volumes:
      - postgres-db3-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # NATS JetStream (Centralized Event Bus)
  # ============================================================================
  nats:
    image: nats:2.10-alpine
    container_name: fraiseql-nats
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring HTTP
    command: [
      "--jetstream",
      "--store_dir=/data",
      "--max_memory_store=2GB",
      "--max_file_store=20GB",
      "--http_port=8222"
    ]
    volumes:
      - nats-data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Redis (Shared Deduplication + Caching)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: fraiseql-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 1GB --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Bridge 1: Database 1 → NATS
  # ============================================================================
  bridge-db1:
    image: fraiseql-observer:latest
    container_name: fraiseql-bridge-db1
    depends_on:
      postgres-db1:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://fraiseql:changeme@postgres-db1:5432/fraiseql_db1
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "true"
      FRAISEQL_NATS_RUN_EXECUTORS: "false"
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_BRIDGE_TRANSPORT_NAME: pg_to_nats_db1  # Unique per bridge
      FRAISEQL_BRIDGE_BATCH_SIZE: "100"
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/04-multi-database-bridge.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

  # ============================================================================
  # Bridge 2: Database 2 → NATS
  # ============================================================================
  bridge-db2:
    image: fraiseql-observer:latest
    container_name: fraiseql-bridge-db2
    depends_on:
      postgres-db2:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://fraiseql:changeme@postgres-db2:5432/fraiseql_db2
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "true"
      FRAISEQL_NATS_RUN_EXECUTORS: "false"
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_BRIDGE_TRANSPORT_NAME: pg_to_nats_db2  # Unique per bridge
      FRAISEQL_BRIDGE_BATCH_SIZE: "100"
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/04-multi-database-bridge.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

  # ============================================================================
  # Bridge 3: Database 3 → NATS
  # ============================================================================
  bridge-db3:
    image: fraiseql-observer:latest
    container_name: fraiseql-bridge-db3
    depends_on:
      postgres-db3:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://fraiseql:changeme@postgres-db3:5432/fraiseql_db3
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "true"
      FRAISEQL_NATS_RUN_EXECUTORS: "false"
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_BRIDGE_TRANSPORT_NAME: pg_to_nats_db3  # Unique per bridge
      FRAISEQL_BRIDGE_BATCH_SIZE: "100"
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/04-multi-database-bridge.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

  # ============================================================================
  # Shared Worker Pool: NATS → Observers
  # ============================================================================
  worker:
    image: fraiseql-observer:latest
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Transport (NATS consumer mode)
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "false"
      FRAISEQL_NATS_RUN_EXECUTORS: "true"

      # NATS configuration
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_NATS_CONSUMER_NAME: fraiseql_observer_worker_group  # Load balancing

      # Redis configuration
      FRAISEQL_REDIS_URL: redis://redis:6379
      FRAISEQL_REDIS_POOL_SIZE: "20"
      FRAISEQL_REDIS_DEDUP_WINDOW_SECS: "300"
      FRAISEQL_REDIS_CACHE_TTL_SECS: "60"

      # Performance features
      FRAISEQL_ENABLE_DEDUP: "true"
      FRAISEQL_ENABLE_CACHING: "true"
      FRAISEQL_ENABLE_CONCURRENT: "true"
      FRAISEQL_MAX_CONCURRENT_ACTIONS: "20"

      # Runtime settings
      FRAISEQL_CHANNEL_CAPACITY: "2000"
      FRAISEQL_MAX_CONCURRENCY: "100"
      FRAISEQL_SHUTDOWN_TIMEOUT: "60s"

      # Logging
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/03-nats-distributed.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped
    # Scale with: docker-compose up --scale worker=10

volumes:
  postgres-db1-data:
    driver: local
  postgres-db2-data:
    driver: local
  postgres-db3-data:
    driver: local
  nats-data:
    driver: local
  redis-data:
    driver: local

# ============================================================================
# Monitoring Commands
# ============================================================================
#
# Check all services:
# docker-compose -f docker-compose.multi-database.yml ps
#
# Check bridge logs:
# docker-compose -f docker-compose.multi-database.yml logs -f bridge-db1
# docker-compose -f docker-compose.multi-database.yml logs -f bridge-db2
# docker-compose -f docker-compose.multi-database.yml logs -f bridge-db3
#
# Check worker logs:
# docker-compose -f docker-compose.multi-database.yml logs -f worker
#
# Check NATS stream:
# docker-compose -f docker-compose.multi-database.yml exec nats nats stream info fraiseql_events
#
# Check NATS consumer (workers):
# docker-compose -f docker-compose.multi-database.yml exec nats nats consumer info fraiseql_events fraiseql_observer_worker_group
#
# Monitor NATS throughput:
# curl http://localhost:8222/varz
#
# Check bridge checkpoints:
# docker-compose -f docker-compose.multi-database.yml exec postgres-db1 psql -U fraiseql -d fraiseql_db1 -c "SELECT * FROM tb_observer_checkpoint;"
# docker-compose -f docker-compose.multi-database.yml exec postgres-db2 psql -U fraiseql -d fraiseql_db2 -c "SELECT * FROM tb_observer_checkpoint;"
# docker-compose -f docker-compose.multi-database.yml exec postgres-db3 psql -U fraiseql -d fraiseql_db3 -c "SELECT * FROM tb_observer_checkpoint;"
#
# Check Redis dedup keys:
# docker-compose -f docker-compose.multi-database.yml exec redis redis-cli KEYS "event:*" | wc -l
#
# Scale workers:
# docker-compose -f docker-compose.multi-database.yml up --scale worker=10
#
# Stop gracefully:
# docker-compose -f docker-compose.multi-database.yml down
#
# Clean restart (clears all data):
# docker-compose -f docker-compose.multi-database.yml down -v
# docker-compose -f docker-compose.multi-database.yml up
