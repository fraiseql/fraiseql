# Docker Compose for Topology 3: NATS Distributed
# ==================================================
#
# Distributed architecture with NATS JetStream for event sourcing.
# PostgreSQL → Bridge → NATS → Multiple Workers (with Redis dedup/cache)
#
# Features:
# - Horizontal scaling (add/remove workers)
# - High availability (workers can fail/restart)
# - At-least-once delivery (NATS + Redis deduplication)
# - Load balancing across workers
# - Geographic distribution support
#
# Best for:
# - Production high-volume systems
# - High availability requirements
# - Event volume > 10000 events/sec
# - Multiple observer workers
#
# Usage:
#   docker-compose -f docker-compose.nats-distributed.yml up
#   docker-compose -f docker-compose.nats-distributed.yml up --scale worker=5  # 5 workers

version: '3.8'

services:
  # PostgreSQL database with observer triggers
  postgres:
    image: postgres:16-alpine
    container_name: fraiseql-postgres
    environment:
      POSTGRES_DB: fraiseql
      POSTGRES_USER: fraiseql
      POSTGRES_PASSWORD: changeme
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NATS JetStream for distributed event sourcing
  nats:
    image: nats:2.10-alpine
    container_name: fraiseql-nats
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring HTTP
    command: [
      "--jetstream",
      "--store_dir=/data",
      "--max_memory_store=1GB",
      "--max_file_store=10GB",
      "--http_port=8222"
    ]
    volumes:
      - nats-data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for deduplication and caching (shared by all workers)
  redis:
    image: redis:7-alpine
    container_name: fraiseql-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Bridge: PostgreSQL → NATS (publishes events from change log)
  bridge:
    image: fraiseql-observer:latest
    container_name: fraiseql-bridge
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      # Database connection
      DATABASE_URL: postgresql://fraiseql:changeme@postgres:5432/fraiseql

      # Transport (NATS bridge mode)
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "true"         # ✅ Run bridge
      FRAISEQL_NATS_RUN_EXECUTORS: "false"        # ❌ Don't run observers

      # NATS configuration
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_NATS_CONSUMER_NAME: fraiseql_bridge

      # Bridge configuration
      FRAISEQL_BRIDGE_TRANSPORT_NAME: pg_to_nats
      FRAISEQL_BRIDGE_BATCH_SIZE: "100"
      FRAISEQL_BRIDGE_POLL_INTERVAL_SECS: "1"
      FRAISEQL_BRIDGE_NOTIFY_CHANNEL: fraiseql_events

      # JetStream configuration
      FRAISEQL_NATS_DEDUP_WINDOW_MINUTES: "5"
      FRAISEQL_NATS_MAX_AGE_DAYS: "7"
      FRAISEQL_NATS_MAX_MSGS: "10000000"
      FRAISEQL_NATS_ACK_WAIT_SECS: "30"
      FRAISEQL_NATS_MAX_DELIVER: "3"

      # Logging
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/04-multi-database-bridge.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped

  # Workers: NATS → Observers (processes events from NATS)
  worker:
    image: fraiseql-observer:latest
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Transport (NATS consumer mode)
      FRAISEQL_OBSERVER_TRANSPORT: nats
      FRAISEQL_NATS_ENABLE_BRIDGE: "false"        # ❌ Don't run bridge
      FRAISEQL_NATS_RUN_EXECUTORS: "true"         # ✅ Run observers

      # NATS configuration
      FRAISEQL_NATS_URL: nats://nats:4222
      FRAISEQL_NATS_SUBJECT_PREFIX: fraiseql.mutation
      FRAISEQL_NATS_STREAM_NAME: fraiseql_events
      FRAISEQL_NATS_CONSUMER_NAME: fraiseql_observer_worker_group  # Same name = load balancing

      # JetStream configuration (same as bridge)
      FRAISEQL_NATS_DEDUP_WINDOW_MINUTES: "5"
      FRAISEQL_NATS_MAX_AGE_DAYS: "7"
      FRAISEQL_NATS_ACK_WAIT_SECS: "30"
      FRAISEQL_NATS_MAX_DELIVER: "3"

      # Redis configuration (shared across workers)
      FRAISEQL_REDIS_URL: redis://redis:6379
      FRAISEQL_REDIS_POOL_SIZE: "20"
      FRAISEQL_REDIS_DEDUP_WINDOW_SECS: "300"     # 5 minutes (matches NATS)
      FRAISEQL_REDIS_CACHE_TTL_SECS: "60"

      # Performance features (all enabled for HA)
      FRAISEQL_ENABLE_DEDUP: "true"               # ✅ CRITICAL: Prevents duplicate processing
      FRAISEQL_ENABLE_CACHING: "true"             # ✅ Cache expensive operations
      FRAISEQL_ENABLE_CONCURRENT: "true"          # ✅ Parallel action execution
      FRAISEQL_MAX_CONCURRENT_ACTIONS: "20"

      # Runtime settings (tuned for high throughput)
      FRAISEQL_CHANNEL_CAPACITY: "2000"
      FRAISEQL_MAX_CONCURRENCY: "100"
      FRAISEQL_SHUTDOWN_TIMEOUT: "60s"

      # Logging
      RUST_LOG: info,fraiseql_observers=debug
    volumes:
      - ./examples/03-nats-distributed.toml:/etc/fraiseql/config.toml:ro
    command: ["--config", "/etc/fraiseql/config.toml"]
    restart: unless-stopped
    # Scale with: docker-compose up --scale worker=5

volumes:
  postgres-data:
    driver: local
  nats-data:
    driver: local
  redis-data:
    driver: local

# Monitoring commands:
# docker-compose -f docker-compose.nats-distributed.yml ps
# docker-compose -f docker-compose.nats-distributed.yml logs -f worker
#
# Check NATS stream:
# docker-compose -f docker-compose.nats-distributed.yml exec nats nats stream info fraiseql_events
#
# Check NATS consumer:
# docker-compose -f docker-compose.nats-distributed.yml exec nats nats consumer info fraiseql_events fraiseql_observer_worker_group
#
# Check Redis dedup keys:
# docker-compose -f docker-compose.nats-distributed.yml exec redis redis-cli KEYS "event:*"
#
# Monitor NATS throughput:
# curl http://localhost:8222/varz
#
# Scale workers:
# docker-compose -f docker-compose.nats-distributed.yml up --scale worker=5
#
# Stop gracefully:
# docker-compose -f docker-compose.nats-distributed.yml down
#
# Clean restart:
# docker-compose -f docker-compose.nats-distributed.yml down -v
# docker-compose -f docker-compose.nats-distributed.yml up
