# PostgreSQL + Redis Observer Configuration
# ============================================
#
# This deployment adds Redis for performance optimization:
# - PostgreSQL LISTEN/NOTIFY for event sourcing
# - Redis for deduplication (at-least-once delivery guarantee)
# - Redis for action result caching (100x faster for repeated actions)
#
# Best for:
# - Single PostgreSQL database
# - Medium event volume (1000-10000 events/sec)
# - Needs reliability (deduplication) and performance (caching)
# - Can run Redis instance

# Transport configuration
[transport]
transport = "postgres"
run_bridge = false
run_executors = true

# Redis configuration (dedup + caching)
[redis]
url = "redis://localhost:6379"
pool_size = 10
connect_timeout_secs = 5
command_timeout_secs = 2
dedup_window_secs = 300     # 5 minutes dedup window
cache_ttl_secs = 60         # 1 minute cache TTL

# Performance features (Redis-backed)
[performance]
enable_dedup = true         # âœ… Event deduplication (prevents duplicate processing)
enable_caching = true       # âœ… Action result caching (100x faster cache hits)
enable_concurrent = true    # âœ… Concurrent action execution
max_concurrent_actions = 10
concurrent_timeout_ms = 30000

# Runtime settings
channel_capacity = 1000
max_concurrency = 50
overflow_policy = "drop"
backlog_alert_threshold = 500
shutdown_timeout = "30s"

# Example observer 1: Webhook on order creation
[[observers]]
event_type = "INSERT"
entity = "Order"

[[observers.actions]]
type = "webhook"
url = "https://analytics.example.com/orders"
body_template = '''
{
  "order_id": "{{ data.id }}",
  "total": {{ data.total }},
  "customer_id": "{{ data.customer_id }}"
}
'''

[observers.retry]
max_attempts = 3
initial_delay_ms = 100
max_delay_ms = 30000
backoff_strategy = "exponential"

# Example observer 2: Email on order shipped (with caching)
[[observers]]
event_type = "UPDATE"
entity = "Order"
condition = "data.status == 'shipped'"

[[observers.actions]]
type = "email"
to_template = "{{ data.customer_email }}"
subject = "Your order has shipped!"
body_template = "Order #{{ data.id }} is on its way. Tracking: {{ data.tracking_number }}"

[observers.retry]
max_attempts = 3
initial_delay_ms = 200
max_delay_ms = 30000

# Example observer 3: Slack notification for high-value orders
[[observers]]
event_type = "INSERT"
entity = "Order"
condition = "data.total > 1000"

[[observers.actions]]
type = "slack"
webhook_url_env = "SLACK_WEBHOOK_URL"
message_template = "ðŸŽ‰ High-value order! ${{ data.total }} from {{ data.customer_email }}"
