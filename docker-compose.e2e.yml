# Docker Compose for FraiseQL E2E Testing
#
# This configuration starts:
# 1. PostgreSQL database with test data
# 2. FraiseQL server with compiled schema
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up -d --build   # Start services
#   ./scripts/run-e2e-tests.sh                               # Run E2E tests
#   docker compose -f docker-compose.e2e.yml down -v         # Cleanup

services:
  # PostgreSQL Database with test data
  postgres:
    image: postgres:16-alpine
    container_name: fraiseql-e2e-postgres
    environment:
      POSTGRES_USER: fraiseql_test
      POSTGRES_PASSWORD: fraiseql_test_password
      POSTGRES_DB: test_fraiseql
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5433:5432"
    volumes:
      - ./tests/sql/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraiseql_test -d test_fraiseql"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - fraiseql-e2e

  # FraiseQL Server
  fraiseql-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fraiseql-e2e-server
    ports:
      - "9001:8000"
    environment:
      RUST_LOG: info,fraiseql_server=debug,fraiseql_core=debug
      DATABASE_URL: postgresql://fraiseql_test:fraiseql_test_password@postgres:5432/test_fraiseql
      # Enable metrics with a test token for E2E testing
      FRAISEQL_METRICS_ENABLED: "true"
      FRAISEQL_METRICS_TOKEN: "e2e-test-metrics-token-32chars!"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./tests/e2e/schema.compiled.json:/app/schemas/schema.compiled.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s
    networks:
      - fraiseql-e2e

networks:
  fraiseql-e2e:
    driver: bridge
