# FraiseQL v2 Security Remediation - TODO Tracking
**Date**: 2026-01-26
**Status**: Analysis Complete, Implementation Ready
**Total Work**: 40 hours across 7 phases

---

## Session Summary (2026-01-25 to 2026-01-26)

### Completed Work ‚úÖ

| Task | Deliverable | Status |
|------|-------------|--------|
| Phase 8 Validation | PHASE_8_E2E_VALIDATION_RESULTS.md | ‚úÖ Complete |
| Phase 9 Validation | PHASE_9_DOCUMENTATION_AUDIT.md | ‚úÖ Complete |
| Release Readiness | GA_RELEASE_READINESS_REPORT.md | ‚úÖ Complete |
| Security Audit | SECURITY_AUDIT_PROFESSIONAL.md | ‚úÖ Complete (14 vulnerabilities) |
| Remediation Plan | SECURITY_FIXES_README.md + 7 phases | ‚úÖ Complete |

**Total Deliverables**: 12 documentation files, 5,000+ lines, 137 KB

---

## Critical Path: MUST FIX BEFORE GA

### üî¥ CRITICAL Priority (Effort: 6 hours)

**These block GA release and must be fixed first.**

#### Phase 11.1: TLS Certificate Validation Bypass
- **File**: `.phases/phase-11.1-tls-security.md`
- **CVSS Score**: 9.8 (CRITICAL)
- **Effort**: 2 hours
- **Risk**: Man-in-the-middle attacks via certificate bypass
- **Status**: [ ] Not Started
- **Next Step**: Begin TDD Cycle 1 - Write failing test for release panic

**Implementation Checklist**:
- [ ] Read phase-11.1-tls-security.md completely
- [ ] TDD Cycle 1: Add release panic check (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 2: Environment variable validation (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 3: Logging and documentation (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] Run all tests: `cargo nextest run`
- [ ] Verify clippy: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] Commit: `git commit -m "fix(security-11.1): Fix TLS certificate validation bypass"`

**Code to Implement**:
```rust
// In release builds, panic if danger mode is enabled
pub fn initialize_tls_config(config: &TlsConfig) -> Result<ServerConfig> {
    if config.danger_accept_invalid_certs {
        #[cfg(not(debug_assertions))]
        {
            panic!("üö® CRITICAL: TLS certificate validation bypass not allowed in release builds");
        }
    }
    // ... rest of implementation
}
```

---

#### Phase 11.2: SQL Injection via JSON Paths
- **File**: `.phases/phase-11.2-sql-injection-fix.md`
- **CVSS Score**: 9.2 (CRITICAL)
- **Effort**: 4 hours
- **Risk**: SQL injection attacks via unescaped field names
- **Status**: [ ] Not Started
- **Next Step**: Begin TDD Cycle 1 - Write failing test for field name escaping

**Implementation Checklist**:
- [ ] Read phase-11.2-sql-injection-fix.md completely
- [ ] TDD Cycle 1: Basic field name escaping (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 2: Schema validation (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 3: Integration testing (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] Run all tests: `cargo nextest run`
- [ ] Verify clippy: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] Commit: `git commit -m "fix(security-11.2): Fix SQL injection in JSON path construction"`

**Code to Implement**:
```rust
// Escape field names before interpolation
fn escape_field_name(name: &str) -> String {
    name.replace("'", "''")  // SQL escape: ' ‚Üí ''
}

fn build_json_path(path: &[String]) -> String {
    if path.len() == 1 {
        let escaped = escape_field_name(&path[0]);
        format!("data->>'{}' ", escaped)
    }
    // ... rest of implementation
}
```

**Files to Modify**:
- `crates/fraiseql-core/src/db/sql_builder.rs`
- `crates/fraiseql-core/src/db/tests.rs`

---

## High Priority: SHOULD FIX BEFORE GA

### üü† HIGH Priority (Effort: 13 hours)

**Recommended for GA, but blocks some use cases.**

#### Phase 11.3: Password Memory Security
- **File**: `.phases/phase-11.3-password-security.md`
- **CVSS Score**: 8.1 (HIGH)
- **Effort**: 3 hours
- **Risk**: Plaintext password exposure in memory with RCE/VM escape
- **Status**: [ ] Not Started
- **Next Step**: Begin TDD Cycle 1 - Add zeroize dependency

**Implementation Checklist**:
- [ ] Read phase-11.3-password-security.md completely
- [ ] Add dependency to Cargo.toml: `zeroize = { version = "1.6", features = ["std", "derive"] }`
- [ ] TDD Cycle 1: Add zeroize wrapper type (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 2: Update DbCredentials struct (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 3: Error message sanitization (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] Run all tests: `cargo nextest run`
- [ ] Verify clippy: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] Commit: `git commit -m "fix(security-11.3): Secure password memory management"`

---

#### Phase 11.4: OIDC Token Cache Poisoning
- **File**: `.phases/phase-11.4-oidc-security.md`
- **CVSS Score**: 7.8 (HIGH)
- **Effort**: 4 hours
- **Risk**: Revoked tokens accepted for extended period after key rotation
- **Status**: [ ] Not Started
- **Next Step**: Begin TDD Cycle 1 - Write failing test for TTL validation

**Implementation Checklist**:
- [ ] Read phase-11.4-oidc-security.md completely
- [ ] TDD Cycle 1: Reduce cache TTL (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 2: Key rotation detection (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 3: Cache invalidation on key miss (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] Run all tests: `cargo nextest run`
- [ ] Verify clippy: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] Commit: `git commit -m "fix(security-11.4): Prevent OIDC token cache poisoning"`

---

#### Phase 11.5: CSRF in Distributed Systems
- **File**: `.phases/phase-11.5-csrf-security.md`
- **CVSS Score**: 7.5 (HIGH)
- **Effort**: 6 hours
- **Risk**: CSRF validation bypassed in load-balanced deployments
- **Status**: [ ] Not Started
- **Next Step**: Begin TDD Cycle 1 - Write failing test for persistent state

**Implementation Checklist**:
- [ ] Read phase-11.5-csrf-security.md completely
- [ ] Add dependencies to Cargo.toml: `redis = { version = "0.24", features = ["aio", "tokio-comp"] }`
- [ ] TDD Cycle 1: Redis state store (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 2: In-memory fallback (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] TDD Cycle 3: OAuth flow integration (RED ‚Üí GREEN ‚Üí REFACTOR ‚Üí CLEANUP)
- [ ] Run all tests: `cargo nextest run`
- [ ] Verify clippy: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] Commit: `git commit -m "fix(security-11.5): Fix CSRF in distributed deployments"`

**Files to Modify**:
- `crates/fraiseql-server/src/auth/state_store.rs` (new file)
- `crates/fraiseql-server/src/auth/handlers.rs`
- `crates/fraiseql-server/src/config.rs`
- `Cargo.toml`

---

## Medium Priority: SHOULD FIX THIS QUARTER

### üü° MEDIUM Priority (Effort: 9 hours)

**Addresses multiple medium-severity vulnerabilities.**

#### Phase 11.6: Data Protection Enhancements
- **File**: `.phases/phase-11.6-data-protection.md`
- **Effort**: 9 hours (4 separate issues)
- **Status**: [ ] Not Started

**Detailed Issue Breakdown**:

| Issue | CVSS | Hours | Next Step |
|-------|------|-------|-----------|
| Error Redaction | 4.3 | 2h | TDD Cycle 1: Write test for error redaction |
| Field Masking | 5.2 | 1h | Extend sensitive field patterns list |
| JSON Ordering | 5.5 | 2h | Implement deterministic key sorting |
| Timing Attack | 4.7 | 1h | Add subtle crate for constant-time compare |

**Implementation Order**:
1. [ ] Error Redaction (2 hours)
2. [ ] Field Masking (1 hour)
3. [ ] JSON Ordering (2 hours)
4. [ ] Bearer Token Comparison (1 hour)
5. [ ] Integration Testing (3 hours)

---

### üîµ LOW Priority: NICE TO HAVE

#### Phase 11.7: Security Enhancements
- **File**: `.phases/phase-11.7-enhancements.md`
- **CVSS Scores**: 1.5 - 3.1 (all LOW)
- **Effort**: 12 hours (5 separate items)
- **Status**: [ ] Not Started

**Items**:
1. [ ] Query Depth/Complexity Limits (3 hours)
2. [ ] Rate Limiting Verification (1 hour)
3. [ ] SCRAM Documentation (1 hour)
4. [ ] Audit Log Integrity (4 hours)
5. [ ] ID Enumeration Prevention (3 hours)

---

## Recommended Implementation Timeline

### Week 1 (12 hours) - CRITICAL Path
```
Day 1 (4h):  Phase 11.1 - TLS Security
Day 2 (8h):  Phase 11.2 - SQL Injection Fix
```

### Week 2 (13 hours) - HIGH Priority
```
Day 1 (3h):  Phase 11.3 - Password Security
Day 2 (4h):  Phase 11.4 - OIDC Cache Poisoning
Day 3 (6h):  Phase 11.5 - CSRF Distributed Systems
```

### Week 3 (9 hours) - MEDIUM Priority
```
Full Week:   Phase 11.6 - Data Protection (4 issues)
```

### Week 4+ (12 hours) - LOW Priority
```
Ongoing:     Phase 11.7 - Enhancements (5 items)
```

---

## Testing Strategy

### For Each Phase

**Unit Tests**:
- [ ] RED: Write failing tests first
- [ ] GREEN: Minimal code to pass
- [ ] Tests in respective crate's `tests/` module or `mod.rs`

**Integration Tests**:
- [ ] Test across crate boundaries
- [ ] Test with actual database (PostgreSQL, SQLite)
- [ ] Test configuration options

**Verification**:
```bash
# After each TDD cycle:
cargo nextest run                    # Run all tests
cargo clippy --all-targets --all-features -- -D warnings
cargo fmt --check
```

### Before Each Commit

```bash
# Ensure everything passes:
cargo check
cargo clippy --all-targets --all-features
cargo nextest run
git status  # Verify only intended files changed
```

---

## Dependencies to Add

### Cargo.toml
```toml
[dependencies]
zeroize = { version = "1.6", features = ["std", "derive"] }
redis = { version = "0.24", features = ["aio", "tokio-comp"] }
subtle = "2.4"
sha2 = "0.10"
hex = "0.4"
```

### Add to Existing
```toml
async-trait = "0.1"  # If not already present
```

---

## Success Criteria for GA Release

- [ ] Phase 11.1 TLS fixes implemented and tested
- [ ] Phase 11.2 SQL injection fixes implemented and tested
- [ ] Phase 11.3 Password security implemented and tested
- [ ] Phase 11.4 OIDC cache fixes implemented and tested
- [ ] Phase 11.5 CSRF fixes implemented and tested
- [ ] Phase 11.6 Data protection fixes implemented and tested
- [ ] All 40+ new tests passing
- [ ] `cargo clippy` clean with zero warnings
- [ ] `cargo test` all passing
- [ ] `cargo fmt` all formatted
- [ ] Git history clean with descriptive commits
- [ ] Documentation updated in relevant files
- [ ] No TODO/FIXME markers in code
- [ ] Security audit passed: `SECURITY_AUDIT_PROFESSIONAL.md` addressed

---

## Reference Documents

### Analysis & Audit
- üìã `SECURITY_AUDIT_PROFESSIONAL.md` - Full vulnerability analysis (1,671 lines)
- üìä `GA_RELEASE_READINESS_REPORT.md` - Pre-release assessment
- üìà `PHASE_8_E2E_VALIDATION_RESULTS.md` - E2E testing validation
- üìñ `PHASE_9_DOCUMENTATION_AUDIT.md` - Documentation accuracy

### Implementation Plans
- üõ°Ô∏è `SECURITY_FIXES_README.md` - Master remediation plan
- üîí `phase-11.1-tls-security.md` - TLS validation bypass fix
- üíâ `phase-11.2-sql-injection-fix.md` - SQL injection prevention
- üîë `phase-11.3-password-security.md` - Password memory protection
- üé´ `phase-11.4-oidc-security.md` - OIDC token cache protection
- üõë `phase-11.5-csrf-security.md` - CSRF in distributed systems
- üîê `phase-11.6-data-protection.md` - Data protection enhancements
- ‚ú® `phase-11.7-enhancements.md` - Low-priority security items

---

## Quick Start Commands

```bash
# Start Phase 11.1
cat .phases/phase-11.1-tls-security.md
# Follow the TDD Cycle 1: RED step

# Check status of all tests
cargo nextest run

# Check code quality
cargo clippy --all-targets --all-features -- -D warnings

# Format code
cargo fmt

# After completing a phase
git commit -m "fix(security-11.X): [description from phase file]"
```

---

## Git Workflow

```bash
# Start new phase work
git checkout -b feature/security-11-x-description

# After completing all TDD cycles
cargo nextest run              # Verify all pass
cargo clippy --all-targets --all-features -- -D warnings
cargo fmt

# Commit with message from phase file template
git commit -m "$(cat <<'EOF'
fix(security-11.X): Description

## Changes
- Change 1
- Change 2

## Verification
‚úÖ Tests pass
‚úÖ Clippy clean
‚úÖ fmt clean

Co-Authored-By: Claude Haiku 4.5 <noreply@anthropic.com>
EOF
)"

# Push for review
git push -u origin feature/security-11-x-description
```

---

## Progress Tracking

### Session: 2026-01-25 to 2026-01-26
- [x] Phase 8 E2E Validation completed
- [x] Phase 9 Documentation Audit completed
- [x] Security Audit completed
- [x] 7-Phase Remediation Plan created
- [ ] Phase 11.1 Implementation (TDD Cycles 1-3)
- [ ] Phase 11.2 Implementation (TDD Cycles 1-3)
- [ ] Phase 11.3 Implementation (TDD Cycles 1-3)
- [ ] Phase 11.4 Implementation (TDD Cycles 1-3)
- [ ] Phase 11.5 Implementation (TDD Cycles 1-3)
- [ ] Phase 11.6 Implementation (Full cycle)
- [ ] Phase 11.7 Implementation (Full cycle)
- [ ] GA Release Approval

---

## Final Checklist Before GA

### Code Quality
- [ ] All lints pass: `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] All tests pass: `cargo nextest run`
- [ ] All code formatted: `cargo fmt --check`
- [ ] No unsafe code blocks without justification

### Security
- [ ] All 14 vulnerabilities addressed
- [ ] All CRITICAL issues fixed
- [ ] All HIGH issues fixed
- [ ] MEDIUM issues addressed
- [ ] Security audit approved

### Documentation
- [ ] README updated with security fixes
- [ ] API docs current
- [ ] Configuration docs complete
- [ ] No development markers remaining

### Release
- [ ] Version bumped appropriately
- [ ] Changelog updated
- [ ] All tests green
- [ ] Performance acceptable
- [ ] Ready for production

---

**Status**: Ready to begin Phase 11.1: TLS Security

**Next Action**: Read `.phases/phase-11.1-tls-security.md` and follow TDD Cycle 1: RED
