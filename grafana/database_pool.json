{
  "dashboard": {
    "title": "FraiseQL Database Pool",
    "tags": ["fraiseql", "database", "pool", "connections"],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "10s",
    "panels": [
      {
        "id": 1,
        "title": "Active Connections",
        "type": "stat",
        "gridPos": {"h": 6, "w": 8, "x": 0, "y": 0},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  metric_value as active_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_active'\n  AND environment = '$environment'\nORDER BY timestamp DESC\nLIMIT 1;",
            "format": "table"
          }
        ],
        "options": {
          "graphMode": "area",
          "colorMode": "value",
          "orientation": "auto",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 15, "color": "yellow"},
                {"value": 25, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 2,
        "title": "Idle Connections",
        "type": "stat",
        "gridPos": {"h": 6, "w": 8, "x": 8, "y": 0},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  metric_value as idle_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_idle'\n  AND environment = '$environment'\nORDER BY timestamp DESC\nLIMIT 1;",
            "format": "table"
          }
        ],
        "options": {
          "graphMode": "area",
          "colorMode": "value",
          "orientation": "auto",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 5, "color": "yellow"},
                {"value": 10, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "id": 3,
        "title": "Total Connections",
        "type": "stat",
        "gridPos": {"h": 6, "w": 8, "x": 16, "y": 0},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  metric_value as total_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_total'\n  AND environment = '$environment'\nORDER BY timestamp DESC\nLIMIT 1;",
            "format": "table"
          }
        ],
        "options": {
          "graphMode": "area",
          "colorMode": "value",
          "orientation": "auto",
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 20, "color": "yellow"},
                {"value": 30, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 4,
        "title": "Connection Pool Over Time",
        "type": "timeseries",
        "gridPos": {"h": 10, "w": 24, "x": 0, "y": 6},
        "targets": [
          {
            "refId": "Active",
            "rawSql": "SELECT\n  date_trunc('minute', timestamp) as time,\n  AVG(metric_value) as active_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_active'\n  AND timestamp >= $__timeFrom()\n  AND timestamp <= $__timeTo()\n  AND environment = '$environment'\nGROUP BY time\nORDER BY time;",
            "format": "time_series",
            "legendFormat": "Active"
          },
          {
            "refId": "Idle",
            "rawSql": "SELECT\n  date_trunc('minute', timestamp) as time,\n  AVG(metric_value) as idle_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_idle'\n  AND timestamp >= $__timeFrom()\n  AND timestamp <= $__timeTo()\n  AND environment = '$environment'\nGROUP BY time\nORDER BY time;",
            "format": "time_series",
            "legendFormat": "Idle"
          },
          {
            "refId": "Total",
            "rawSql": "SELECT\n  date_trunc('minute', timestamp) as time,\n  AVG(metric_value) as total_connections\nFROM monitoring.metrics\nWHERE metric_name = 'db_connections_total'\n  AND timestamp >= $__timeFrom()\n  AND timestamp <= $__timeTo()\n  AND environment = '$environment'\nGROUP BY time\nORDER BY time;",
            "format": "time_series",
            "legendFormat": "Total"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "palette-classic"},
            "custom": {
              "lineInterpolation": "smooth",
              "showPoints": "never",
              "fillOpacity": 10
            },
            "unit": "short"
          }
        }
      },
      {
        "id": 5,
        "title": "Database Query Rate",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  date_trunc('minute', timestamp) as time,\n  labels->>'query_type' as query_type,\n  SUM(metric_value) / 60.0 as queries_per_second\nFROM monitoring.metrics\nWHERE metric_name = 'db_queries_total'\n  AND timestamp >= $__timeFrom()\n  AND timestamp <= $__timeTo()\n  AND environment = '$environment'\nGROUP BY time, query_type\nORDER BY time;",
            "format": "time_series"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "palette-classic"},
            "custom": {
              "lineInterpolation": "smooth",
              "showPoints": "never",
              "fillOpacity": 10
            },
            "unit": "qps"
          }
        }
      },
      {
        "id": 6,
        "title": "Query Types Distribution",
        "type": "piechart",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  labels->>'query_type' as query_type,\n  SUM(metric_value) as total_queries\nFROM monitoring.metrics\nWHERE metric_name = 'db_queries_total'\n  AND timestamp > NOW() - INTERVAL '$time_range'\n  AND environment = '$environment'\nGROUP BY query_type\nORDER BY total_queries DESC;",
            "format": "table"
          }
        ],
        "options": {
          "legend": {"displayMode": "table", "placement": "right"},
          "pieType": "donut",
          "displayLabels": ["name", "percent"]
        }
      },
      {
        "id": 7,
        "title": "Database Query Duration",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
        "targets": [
          {
            "refId": "P50",
            "rawSql": "WITH query_times AS (\n  SELECT\n    date_trunc('minute', timestamp) as time,\n    labels->>'query_type' as query_type,\n    metric_value * 1000 as duration_ms\n  FROM monitoring.metrics\n  WHERE metric_name = 'db_query_duration_seconds'\n    AND timestamp >= $__timeFrom()\n    AND timestamp <= $__timeTo()\n    AND environment = '$environment'\n)\nSELECT\n  time,\n  percentile_cont(0.50) WITHIN GROUP (ORDER BY duration_ms) as p50_ms\nFROM query_times\nGROUP BY time\nORDER BY time;",
            "format": "time_series",
            "legendFormat": "P50"
          },
          {
            "refId": "P95",
            "rawSql": "WITH query_times AS (\n  SELECT\n    date_trunc('minute', timestamp) as time,\n    labels->>'query_type' as query_type,\n    metric_value * 1000 as duration_ms\n  FROM monitoring.metrics\n  WHERE metric_name = 'db_query_duration_seconds'\n    AND timestamp >= $__timeFrom()\n    AND timestamp <= $__timeTo()\n    AND environment = '$environment'\n)\nSELECT\n  time,\n  percentile_cont(0.95) WITHIN GROUP (ORDER BY duration_ms) as p95_ms\nFROM query_times\nGROUP BY time\nORDER BY time;",
            "format": "time_series",
            "legendFormat": "P95"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "palette-classic"},
            "custom": {
              "lineInterpolation": "smooth",
              "showPoints": "never"
            },
            "unit": "ms"
          }
        }
      },
      {
        "id": 8,
        "title": "Top Tables by Query Count",
        "type": "table",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
        "targets": [
          {
            "refId": "A",
            "rawSql": "SELECT\n  labels->>'table_name' as table_name,\n  labels->>'query_type' as query_type,\n  SUM(metric_value) as query_count\nFROM monitoring.metrics\nWHERE metric_name = 'db_queries_total'\n  AND timestamp > NOW() - INTERVAL '$time_range'\n  AND environment = '$environment'\nGROUP BY table_name, query_type\nORDER BY query_count DESC\nLIMIT 20;",
            "format": "table"
          }
        ],
        "fieldConfig": {
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "query_count"},
              "properties": [
                {
                  "id": "custom.cellOptions",
                  "value": {
                    "type": "color-background",
                    "mode": "gradient"
                  }
                }
              ]
            }
          ]
        }
      },
      {
        "id": 9,
        "title": "Pool Utilization Rate",
        "type": "gauge",
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 32},
        "targets": [
          {
            "refId": "A",
            "rawSql": "WITH latest_metrics AS (\n  SELECT DISTINCT ON (metric_name)\n    metric_name,\n    metric_value\n  FROM monitoring.metrics\n  WHERE metric_name IN ('db_connections_active', 'db_connections_total')\n    AND environment = '$environment'\n  ORDER BY metric_name, timestamp DESC\n)\nSELECT\n  ROUND(100.0 * \n    (SELECT metric_value FROM latest_metrics WHERE metric_name = 'db_connections_active') /\n    NULLIF((SELECT metric_value FROM latest_metrics WHERE metric_name = 'db_connections_total'), 0)\n  , 2) as utilization_percent;",
            "format": "table"
          }
        ],
        "options": {
          "showThresholdLabels": true,
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 60, "color": "yellow"},
                {"value": 80, "color": "orange"},
                {"value": 90, "color": "red"}
              ]
            }
          }
        }
      }
    ],
    "templating": {
      "list": [
        {
          "name": "environment",
          "type": "custom",
          "options": [
            {"text": "production", "value": "production"},
            {"text": "staging", "value": "staging"},
            {"text": "development", "value": "development"}
          ],
          "current": {"text": "production", "value": "production"},
          "multi": false
        },
        {
          "name": "time_range",
          "type": "custom",
          "options": [
            {"text": "1 hour", "value": "1 hour"},
            {"text": "6 hours", "value": "6 hours"},
            {"text": "24 hours", "value": "24 hours"},
            {"text": "7 days", "value": "7 days"}
          ],
          "current": {"text": "1 hour", "value": "1 hour"},
          "multi": false
        }
      ]
    },
    "time": {
      "from": "now-1h",
      "to": "now"
    }
  },
  "overwrite": true,
  "message": "FraiseQL Database Pool Dashboard"
}
