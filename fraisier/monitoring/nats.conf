# NATS Server Configuration for Fraisier
#
# This configuration sets up NATS with JetStream enabled for persistent event sourcing
# in Fraisier's multi-region deployment coordination system.

# Server configuration
server {
  name: "fraisier-nats"
  port: 4222

  # Enable monitoring
  http_port: 8222

  # Cluster configuration (optional, for HA deployments)
  # cluster {
  #   name: "fraisier-cluster"
  #   listen: "0.0.0.0:6222"
  #   routes: [
  #     nats://localhost:6222
  #   ]
  # }
}

# Authentication
# For development: basic authentication with default credentials
# For production: use NATS external auth (NKey or JWT)
authorization {
  user: "fraisier"
  password: "fraisier_password"

  # Additional users for different services
  # users: [
  #   { user: "admin", password: "admin_password", permissions: { publish: ">", subscribe: ">" } },
  #   { user: "monitor", password: "monitor_password", permissions: { subscribe: "$SYS.>" } }
  # ]
}

# JetStream Configuration
# Persistent event store for deployment events, health checks, and database changes
jetstream {
  # Storage location for JetStream data
  store_dir: "/data/nats"

  # Limits
  max_memory_store: 256MB
  max_file_store: 1GB
  max_outstanding_catchup: 33MB

  # Duplicate window (for deduplication)
  duplicate_window: 2m

  # Cleanup interval
  purge_interval: 5m
}

# Stream Definitions
# These streams persist events published by Fraisier providers
# Streams are created with automatic configuration for event-driven coordination

# Note: Streams are typically created programmatically via the NatsEventBus
# This allows dynamic stream creation based on runtime configuration

# Example stream definitions (commented out - created by application):
#
# stream: {
#   name: "DEPLOYMENT_EVENTS"
#   description: "Deployment lifecycle events from all providers"
#   subjects: ["fraisier.deployments.>"]
#   max_age: 720h  # 30 days retention
#   storage: file
#   replicas: 1
#   discard: old  # Discard oldest messages when full
# }
#
# stream: {
#   name: "HEALTH_CHECK_EVENTS"
#   description: "Health check results from all providers"
#   subjects: ["fraisier.health_checks.>"]
#   max_age: 168h  # 7 days retention
#   storage: file
#   replicas: 1
#   discard: old
# }
#
# stream: {
#   name: "DATABASE_EVENTS"
#   description: "Database change events for multi-database coordination"
#   subjects: ["fraisier.database.>"]
#   max_age: 720h  # 30 days retention
#   storage: file
#   replicas: 1
#   discard: old
# }
#
# stream: {
#   name: "METRICS_EVENTS"
#   description: "Deployment metrics and performance data"
#   subjects: ["fraisier.metrics.>"]
#   max_age: 168h  # 7 days retention
#   storage: file
#   replicas: 1
#   discard: old
# }

# Logging
logging {
  time_format: "2006-01-02T15:04:05.000Z07:00"
  debug: false
  trace: false
  color: true

  # Log file (optional)
  # logfile: "/var/log/nats/nats.log"
}

# System limits
system_limits {
  max_connections: 10000
  max_subscriptions: 1000000
  max_pending_size: 100MB
}

# Connection settings
connection_settings {
  # Ping/pong interval for detecting broken connections
  ping_interval: 2m

  # Max time allowed to send to a client
  write_deadline: 10s

  # TLS (optional, for production)
  # tls {
  #   cert_file: "/etc/nats/certs/server.crt"
  #   key_file: "/etc/nats/certs/server.key"
  #   ca_file: "/etc/nats/certs/ca.crt"
  #   verify: true
  # }
}

# Monitoring and metrics
monitor_ready_command: "http://localhost:8222/healthz"
monitor_ready_interval: 5s
