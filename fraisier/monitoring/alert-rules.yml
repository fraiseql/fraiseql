"""Prometheus alert rules for Fraisier deployment orchestrator.

Alerts for:
- Deployment failures
- High error rates
- Service unavailability
- Resource constraints
"""

groups:
  - name: fraisier_deployment
    interval: 30s
    rules:
      # ========================================================================
      # Deployment Strategy Alerts
      # ========================================================================
      - alert: DeploymentFailure
        expr: fraisier_deployment_failed_total > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Deployment failure detected"
          description: "Service {{ $labels.service }} deployment to version {{ $labels.version }} failed"

      - alert: DeploymentRollback
        expr: fraisier_deployment_rollback_total > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Deployment rollback triggered"
          description: "Service {{ $labels.service }} rolled back to {{ $labels.version }}"

      # ========================================================================
      # Health Check Alerts
      # ========================================================================
      - alert: HealthCheckFailure
        expr: rate(fraisier_health_check_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High health check failure rate"
          description: "Service {{ $labels.service }} health checks failing at {{ $value | humanize }}% rate"

      # ========================================================================
      # Deployment Metrics Alerts
      # ========================================================================
      - alert: HighErrorRate
        expr: fraisier_deployment_error_rate > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate in deployment"
          description: "Service {{ $labels.service }} has {{ $value | humanize }}% error rate during deployment"

      - alert: HighLatency
        expr: fraisier_deployment_latency_p99 > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "Service {{ $labels.service }} P99 latency is {{ $value | humanize }}ms"

      - alert: HighMemoryUsage
        expr: fraisier_deployment_memory_usage > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage in deployment"
          description: "Service {{ $labels.service }} memory usage is {{ $value | humanize }}%"

      - alert: HighCPUUsage
        expr: fraisier_deployment_cpu_usage > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage in deployment"
          description: "Service {{ $labels.service }} CPU usage is {{ $value | humanize }}%"

      # ========================================================================
      # Service Availability Alerts
      # ========================================================================
      - alert: ServiceUnavailable
        expr: up{job="fraisier"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Fraisier service is unavailable"
          description: "Fraisier has been down for more than 2 minutes"

      # ========================================================================
      # Database Connection Alerts
      # ========================================================================
      - alert: DatabaseConnectionPoolExhausted
        expr: fraisier_db_connection_pool_exhausted > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool exhausted"
          description: "Database {{ $labels.database }} connection pool is exhausted"

      - alert: DatabaseConnectionTimeout
        expr: rate(fraisier_db_connection_timeout_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection timeout rate"
          description: "Database {{ $labels.database }} connection timeouts detected"
