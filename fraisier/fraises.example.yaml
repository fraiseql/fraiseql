# Fraisier Configuration Example
# ================================
# A fraise is a deployable service (from French "fraise" = strawberry)
# Fraisier (the strawberry plant) orchestrates deployment of fraises

# ============================================================
# GIT PROVIDER CONFIGURATION
# Supports: github, gitlab, gitea, bitbucket (or custom)
# ============================================================
git:
  # Default provider (can be overridden per-fraise)
  provider: github

  # GitHub configuration (github.com or GitHub Enterprise)
  github:
    base_url: https://github.com  # or https://github.mycompany.com
    webhook_secret: ${FRAISIER_WEBHOOK_SECRET}  # from environment

  # GitLab configuration (gitlab.com or self-hosted)
  gitlab:
    base_url: https://gitlab.com  # or https://gitlab.mycompany.com
    secret_token: ${FRAISIER_WEBHOOK_SECRET}

  # Gitea configuration (self-hosted, also works with Forgejo)
  gitea:
    base_url: https://gitea.mycompany.com
    webhook_secret: ${FRAISIER_WEBHOOK_SECRET}

  # Bitbucket configuration (Cloud or Server)
  bitbucket:
    base_url: https://bitbucket.org  # or https://bitbucket.mycompany.com
    server: false  # set to true for Bitbucket Server/Data Center
    webhook_secret: ${FRAISIER_WEBHOOK_SECRET}

# ============================================================
# FRAISES (Services)
# ============================================================
fraises:
  # ============================================================
  # API SERVICE EXAMPLE
  # Web services with systemd, health checks, database migrations
  # ============================================================
  my_api:
    type: api
    description: My awesome GraphQL API
    environments:
      development:
        name: api.myapp.dev
        branch: dev
        git_repo: /var/git/api.myapp.dev.git
        app_path: /var/www/api.myapp.dev
        systemd_service: api.myapp.dev.service
        database:
          name: myapp_development
          strategy: rebuild  # drop and recreate (dev only!)
        health_check:
          url: https://api.myapp.dev/health
          timeout: 30

      staging:
        name: api.myapp.staging
        branch: staging
        git_repo: /var/git/api.myapp.staging.git
        app_path: /var/www/api.myapp.staging
        systemd_service: api.myapp.staging.service
        database:
          name: myapp_staging
          strategy: rebuild
        health_check:
          url: https://api.myapp.staging/health
          timeout: 30

      production:
        name: api.myapp.io
        branch: main
        git_repo: /var/git/api.myapp.io.git
        app_path: /var/www/api.myapp.io
        systemd_service: api.myapp.io.service
        database:
          name: myapp_production
          strategy: apply  # safe migrations only, never drop
          backup_before_deploy: true
        health_check:
          url: https://api.myapp.io/health
          timeout: 30

  # ============================================================
  # SELF-HOSTED GITLAB EXAMPLE
  # Using GitLab instead of GitHub
  # ============================================================
  internal_api:
    type: api
    description: Internal API (hosted on GitLab)
    git:
      provider: gitlab  # Override default provider
      base_url: https://gitlab.mycompany.com
    environments:
      production:
        name: internal-api
        branch: main
        app_path: /var/www/internal-api
        systemd_service: internal-api.service

  # ============================================================
  # GITEA EXAMPLE (self-hosted)
  # ============================================================
  homelab_api:
    type: api
    description: Homelab API (Gitea)
    git:
      provider: gitea
      base_url: https://git.homelab.local
    environments:
      production:
        name: homelab-api
        branch: main
        app_path: /opt/homelab/api
        systemd_service: homelab-api.service

  # ============================================================
  # ETL PIPELINE EXAMPLE
  # ============================================================
  etl:
    type: etl
    description: ETL pipeline for data processing
    environments:
      production:
        name: myapp-etl
        app_path: /var/www/api.myapp.io  # shares code with API
        script_path: scripts/etl/run_etl
        database:
          name: myapp_production
        notifications:
          on_success: scripts/etl/success_notification
          on_failure: scripts/etl/failure_notification

  # ============================================================
  # SCHEDULED JOBS EXAMPLE
  # ============================================================
  statistics:
    type: scheduled
    description: Statistics and report generation
    environments:
      production:
        jobs:
          daily_stats:
            name: myapp-daily-stats
            description: Daily statistics calculation
            systemd_service: myapp-daily-stats.service
            systemd_timer: myapp-daily-stats.timer
            schedule: "0 2 * * *"  # Daily at 02:00

          weekly_report:
            name: myapp-weekly-report
            description: Weekly report generation
            systemd_service: myapp-weekly-report.service
            systemd_timer: myapp-weekly-report.timer
            schedule: "0 8 * * 1"  # Monday at 08:00

  # ============================================================
  # BACKUP JOBS EXAMPLE
  # ============================================================
  backup:
    type: backup
    description: Database backup and remote sync
    environments:
      production:
        jobs:
          local_backup:
            name: myapp-backup-db
            description: Local database backup (PostgreSQL dump)
            systemd_service: myapp-backup-db.service
            systemd_timer: myapp-backup-db.timer
            schedule: "0 */6 * * *"  # Every 6 hours
            script_path: scripts/backup/backup_db
            retention_days: 7

          sync_to_s3:
            name: myapp-backup-sync-s3
            description: Sync backups to S3
            systemd_service: myapp-backup-sync-s3.service
            systemd_timer: myapp-backup-sync-s3.timer
            schedule: "0 * * * *"  # Hourly
            depends_on: local_backup

# ============================================================
# ENVIRONMENTS
# Server and infrastructure configuration per environment
# ============================================================
environments:
  development:
    server: dev.myserver.com
    log_dir: /var/log/myapp-dev
    notifications:
      enabled: false

  staging:
    server: staging.myserver.com
    log_dir: /var/log/myapp-staging
    notifications:
      enabled: false

  production:
    server: prod.myserver.com
    log_dir: /var/log/myapp
    notifications:
      enabled: true
      slack_channel: "#deployments"

# ============================================================
# BRANCH MAPPING
# Maps git branches to fraise deployments (for webhook routing)
# ============================================================
branch_mapping:
  dev:
    fraise: my_api
    environment: development
  staging:
    fraise: my_api
    environment: staging
  main:
    fraise: my_api
    environment: production
