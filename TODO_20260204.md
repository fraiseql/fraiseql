# TODO - February 4, 2026

## Overview

This document tracks outstanding work following the FraiseQL v2 Security Vulnerabilities Implementation (Phase 1-7 complete). All critical and high-priority security fixes are complete. Medium-priority items need review for follow-up work.

---

## ‚úÖ Completed Work (Feb 3-4, 2026)

### Security Vulnerabilities Fixed

All 8 security vulnerabilities from the original plan are now addressed:

#### CRITICAL (3/3) ‚úÖ
- [x] **Phase 1: Admin Endpoints Protection** - Bearer token auth required
  - Files: `server_config.rs`, `server.rs`, `main.rs`
  - Tests: 9 test cases (admin_api_security_test.rs)
  - Status: Production ready

- [x] **Phase 2: Introspection & Schema Export Protection** - Disabled by default, optional auth
  - Files: `server_config.rs`, `server.rs`, `routes/api/mod.rs`
  - Tests: 15 test cases (introspection_security_test.rs)
  - Status: Production ready

- [x] **Phase 3: JWT Audience Validation** - Mandatory audience claim
  - Files: `crates/fraiseql-core/src/security/oidc.rs`
  - Tests: 11 test cases (oidc_audience_validation_test.rs)
  - Status: Production ready

#### HIGH (2/2) ‚úÖ
- [x] **Phase 4: Playground & CORS Production Safety** - Disabled by default, validated in prod
  - Files: `server_config.rs`, added production mode detection
  - Tests: 16 test cases (production_safety_test.rs)
  - Status: Production ready

- [x] **Phase 5: Metrics/Sensitive Operations** - Bearer token protected (pre-existing)
  - Status: Already implemented

#### MEDIUM (3/3 - 2 Complete, 1 Partial)
- [x] **Design Audit API Protection** - Optional OIDC auth
  - Files: `server.rs` (lines 378-421)
  - Status: Complete, no follow-up needed

- [x] **Schema Export Protection** - Follows introspection settings
  - Files: `server.rs` (lines 295-323)
  - Status: Complete, comprehensive tests

- [‚ö†Ô∏è] **Rate Limiting** - Implemented but NOT WIRED (see below)
  - Files: `src/middleware/rate_limit.rs`, `src/auth/rate_limiting.rs`
  - Status: Partial - middleware exists but not activated in server

---

## üî¥ HIGH PRIORITY - Outstanding Work

### 1. Wire Rate Limiting Middleware into Server

**Issue**: Rate limiting code exists and is well-tested but NOT connected to the server router.

**Impact**: The following endpoints are unprotected from DoS/abuse:
- GraphQL query endpoint (`/graphql`)
- Design audit endpoints (`/api/v1/design/*`)
- Schema export endpoints (`/api/v1/schema.graphql`, `/api/v1/schema.json`)
- Admin endpoints (only bearer token protected, no rate limit)
- Metrics endpoint (only bearer token protected, no rate limit)

**What exists**:
- ‚úÖ General rate limiter middleware: `src/middleware/rate_limit.rs`
- ‚úÖ Auth-specific rate limiter: `src/auth/rate_limiting.rs` (activated, working)
- ‚úÖ Configuration support: `src/config/rate_limiting.rs`
- ‚úÖ Comprehensive tests: 459 auth rate limit tests, rate limit middleware tests

**What's missing**:
- ‚ùå No `.layer(rate_limit_middleware)` call in `server.rs`
- ‚ùå No `rate_limiting_enabled` config field in `ServerConfig`
- ‚ùå No environment variable support for rate limiting config

**Tasks**:

- [ ] **Add rate limiting configuration to ServerConfig**
  - Add: `rate_limiting_enabled: bool` (default: true)
  - Add: Optional `rate_limiting_config` with per-IP and per-user limits
  - Add: Environment variable support (`FRAISEQL_RATE_LIMITING_ENABLED`)
  - File: `crates/fraiseql-server/src/server_config.rs`

- [ ] **Wire middleware into server**
  - Add rate limit middleware layer to router
  - Apply after auth middleware but before main routes
  - Location: `crates/fraiseql-server/src/server.rs` (around line 429)
  - Code pattern to follow:
    ```rust
    if self.config.rate_limiting_enabled {
        app = app.layer(rate_limit_middleware(self.config.rate_limiting_config.clone()));
    }
    ```

- [ ] **Create end-to-end tests**
  - Test rate limiting actually works on GraphQL endpoint
  - Test rate limiting on design endpoints
  - Test rate limiting on schema export
  - File: `crates/fraiseql-server/tests/rate_limiting_integration_test.rs`
  - Should verify:
    - Requests fail with 429 when limit exceeded
    - X-RateLimit headers present in response
    - Per-IP limits work independently from per-user limits
    - Limits reset properly after window

- [ ] **Update documentation**
  - Add rate limiting section to `docs/ARCHITECTURE_PRINCIPLES.md`
  - Document configuration options
  - Update `SECURITY_MIGRATION_v2.1.md` with rate limiting info

**Estimated effort**: 2-3 hours

**Test status**: Most tests already exist; just need integration tests

---

## üü° MEDIUM PRIORITY - Recommended Enhancements

### 1. Design Endpoint Rate Limiting Configuration

**Enhancement**: Allow specific rate limit rules for design endpoints (currently uses general limits)

**Benefit**: Design endpoints are expensive operations; may need different limits than standard queries

**Tasks**:
- [ ] Add design-endpoint-specific rate limit configuration
- [ ] Document recommended limits for design endpoints
- [ ] Add configuration examples

**Estimated effort**: 1-2 hours

**Priority**: Optional - can be added later if design endpoints show abuse patterns

### 2. Update Security Configuration Documentation

**Enhancement**: Add section to `.claude/CLAUDE.md` about rate limiting deployment

**Tasks**:
- [ ] Document rate limiting in CLAUDE.md
- [ ] Add example configurations for different environments
- [ ] Document monitoring/observability for rate limit metrics

**Estimated effort**: 1 hour

---

## üü¢ TESTS & VERIFICATION

### Test Status Summary

| Test Suite | Count | Status | File |
|-----------|-------|--------|------|
| Admin API Security | 9 | ‚úÖ Passing | `tests/admin_api_security_test.rs` |
| Introspection Security | 15 | ‚úÖ Passing | `tests/introspection_security_test.rs` |
| OIDC Audience Validation | 11 | ‚úÖ Passing | `tests/oidc_audience_validation_test.rs` |
| Production Safety | 16 | ‚úÖ Passing | `tests/production_safety_test.rs` |
| **Total Security Tests** | **51** | ‚úÖ **100% Pass** | Various |

### To Do - Additional Testing

- [ ] Rate limiting integration tests (NEW)
- [ ] End-to-end security test with all features enabled
- [ ] Load testing to verify rate limiting effectiveness
- [ ] Penetration testing (out of scope for this phase)

---

## üìã FILES SUMMARY

### Files Created (10)
‚úÖ All passing tests and documentation

```
crates/fraiseql-core/tests/oidc_audience_validation_test.rs (11 tests)
crates/fraiseql-server/tests/admin_api_security_test.rs (9 tests)
crates/fraiseql-server/tests/introspection_security_test.rs (15 tests)
crates/fraiseql-server/tests/production_safety_test.rs (16 tests)
docs/SECURITY_MIGRATION_v2.1.md (migration guide)
TODO_20260204.md (this file)
```

### Files Modified (5)
‚úÖ All compiling without warnings

```
crates/fraiseql-core/src/security/oidc.rs
crates/fraiseql-server/src/server_config.rs
crates/fraiseql-server/src/server.rs
crates/fraiseql-server/src/routes/api/mod.rs
crates/fraiseql-server/src/main.rs
```

---

## üöÄ DEPLOYMENT CHECKLIST

### Before Rolling Out v2.1 to Production

- [ ] **Rate limiting** is wired and tested (HIGH PRIORITY)
- [ ] **Migration guide** reviewed with ops team (`docs/SECURITY_MIGRATION_v2.1.md`)
- [ ] **Environment variables** documented:
  - `FRAISEQL_ENV=production` (optional, default)
  - `FRAISEQL_ADMIN_API_ENABLED` and `FRAISEQL_ADMIN_TOKEN` (if needed)
  - `FRAISEQL_INTROSPECTION_ENABLED` and `FRAISEQL_INTROSPECTION_REQUIRE_AUTH` (if needed)
  - `FRAISEQL_PLAYGROUND_ENABLED` (should be false for prod)
  - `FRAISEQL_RATE_LIMITING_ENABLED` (new, once implemented)
- [ ] **Configuration files** updated for production
  - OIDC audience configured
  - CORS origins set explicitly
  - Playground disabled
  - Admin API auth configured (if needed)
- [ ] **Monitoring/alerting** set up for:
  - 429 rate limit responses
  - Failed authentications
  - Configuration errors
- [ ] **Team training** on new security features and breaking changes
- [ ] **Runbook** created for security-related troubleshooting

---

## üìù NOTES

### Architectural Observations

1. **Rate Limiting Architecture**: Well-designed but incomplete deployment
   - The middleware pattern is correct (Axum tower middleware)
   - Token bucket algorithm is solid
   - Per-IP and per-user tracking is proper
   - Just needs to be connected to the router

2. **Security Pattern Consistency**: Good adherence to existing patterns
   - Bearer token auth for admin/metrics
   - OIDC auth for introspection/design/schema
   - Configuration defaults are fail-secure
   - Error messages are clear and actionable

3. **Test Coverage**: Excellent
   - 51 security tests created
   - All test patterns consistent
   - Edge cases covered
   - Tests for configuration validation, not just happy path

### Known Limitations (Documented)

- Rate limiting doesn't persist across server restarts (in-memory only)
  - Solution: Configure Redis backend if needed
- No distributed rate limiting for multi-server deployments
  - Solution: Would require Redis integration (already supported in config)
- Design endpoints don't have specific rate limit rules (use general limits)
  - Solution: Add design-endpoint-specific rules (medium priority)

---

## üîó Related Documentation

- Security Implementation Plan: See original plan document
- Architecture: `docs/ARCHITECTURE_PRINCIPLES.md`
- Migration Guide: `docs/SECURITY_MIGRATION_v2.1.md`
- Development Guidelines: `.claude/CLAUDE.md`
- Implementation Status: `crates/fraiseql-server/src/middleware/rate_limit.rs` (comments)

---

## üë§ Assignee Notes

**For Next Phase**:
- Rate limiting integration is the critical blocker
- Once wired, system is production-ready
- All high-priority security items are complete
- Medium-priority enhancements can be done post-deployment if needed

**Questions to Answer**:
1. Should rate limiting be enabled by default or opt-in?
2. What should default limits be for different endpoint types?
3. Should we use Redis backend for distributed deployments?
4. Do we need monitoring/alerting for rate limit events?

---

## üìÖ Timeline

- **Feb 3-4, 2026**: Security implementation phases 1-7 ‚úÖ
- **Feb 4 (pending)**: Wire rate limiting middleware
- **Feb 4 (pending)**: Add rate limiting tests
- **Feb 4 (pending)**: Update documentation
- **Ready for deployment**: Feb 4, 2026 (after rate limiting)

---

**Last Updated**: February 4, 2026
**Status**: In Progress - Rate Limiting Pending
**Owner**: Security Implementation Team
