# FraiseQL Federation Integration Tests - Tomorrow's Work (2026-01-28)

## Current Status (as of 2026-01-27)

**Completed**: 4/8 tasks (50%)
- âœ… Task #1: Docker Compose multi-subgraph setup (980 lines)
- âœ… Task #2: 2-subgraph federation tests (955 lines)
- âœ… Task #3: Extended mutations tests (471 lines)
- âœ… Task #4: Composite key multi-tenant tests (525 lines)

**Total Lines Written**: 4,331+ lines across infrastructure, tests, and documentation

---

## Tomorrow's Priorities

### PRIMARY GOAL
Complete Task #5 (3+ Subgraph Federation Tests) as next high-value deliverable

### SECONDARY GOAL
If time permits, begin Task #6 (Apollo Router Schema Composition)

---

## Task #5: 3+ Subgraph Federation Tests

### Overview
Expand from 2-subgraph to 3-subgraph federation architecture by activating the products subgraph that's already in Docker Compose. Test 3-hop federated queries and multi-level entity resolution.

### Architecture
```
Users Subgraph (Port 4001) â†’ Orders Subgraph (Port 4002) â†’ Products Subgraph (Port 4003)
    â†“                           â†“                              â†“
PostgreSQL Users          PostgreSQL Orders            PostgreSQL Products
```

### Implementation Checklist

#### Step 1: Verify Products Subgraph in Docker Compose
- [ ] Confirm products service definition exists in docker-compose.yml
- [ ] Verify products service ports (4003)
- [ ] Verify products PostgreSQL configuration (port 5434)
- [ ] Check products-subgraph service has correct environment variables
- [ ] Verify federation.toml exists for products service
- [ ] Ensure products service can resolve Order entities (HTTP to orders-subgraph)

**Files to check**:
- `/home/lionel/code/fraiseql/tests/integration/docker-compose.yml` (products-subgraph section)
- `/home/lionel/code/fraiseql/tests/integration/services/products/federation.toml`
- `/home/lionel/code/fraiseql/tests/integration/services/products/start.sh`

#### Step 2: Write 3+ Subgraph Integration Tests
Add tests to `/home/lionel/code/fraiseql/crates/fraiseql-core/tests/federation_docker_compose_integration.rs`

**Test Scenarios to Implement**:

1. **test_three_subgraph_setup_validation**
   - Wait for all 3 services (users, orders, products)
   - Verify Apollo Router gateway is ready
   - Validates environment supports 3-subgraph federation

2. **test_three_subgraph_direct_queries**
   - Query products directly: `{ products { id name price } }`
   - Verify products subgraph is operational
   - Baseline functionality check

3. **test_three_subgraph_order_with_products**
   - Query orders with products field
   - Orders subgraph extends Product
   - Tests direct 2-hop within orders subgraph

4. **test_three_subgraph_federation_users_orders_products**
   - 3-hop federated query: users â†’ orders â†’ products
   - Query structure:
     ```graphql
     query {
         users(limit: 2) {
             id identifier
             orders {
                 id status
                 products { id name price }
             }
         }
     }
     ```
   - Validates full 3-level federation through gateway

5. **test_three_subgraph_entity_resolution_chain**
   - Get user from users subgraph
   - Get order for that user from orders subgraph
   - Get products for that order from products subgraph
   - Verify composite key consistency across 3 hops

6. **test_three_subgraph_cross_boundary_federation**
   - Products referenced from orders (extended)
   - User referenced from products (transitive)
   - Tests federation propagation across 3 boundaries

7. **test_three_subgraph_mutation_propagation**
   - Create product in products subgraph (local)
   - Create order referencing product (orders subgraph)
   - Create user in users subgraph
   - Verify all mutations respect federation boundaries

8. **test_three_subgraph_batch_entity_resolution**
   - Query 5 users with orders and products
   - Each user has multiple orders
   - Each order has multiple products
   - Measure performance of batch 3-hop resolution

9. **test_three_subgraph_gateway_composition**
   - Verify Apollo Router can compose all 3 subgraph schemas
   - Check SDL includes all types and federation directives
   - Validate gateway query planning for complex queries

10. **test_three_subgraph_performance**
    - 3-hop query for 10 users + orders + products
    - Target: < 5 seconds total latency
    - Measure each hop latency contribution

#### Step 3: Create 3+ Subgraph Documentation
Create `/home/lionel/code/fraiseql/tests/integration/3SUBGRAPH_FEDERATION.md`

**Sections to Include**:
- Architecture overview with ASCII diagrams
- Schema composition across 3 subgraphs
- Federation directives and extensions
- Entity resolution chains (3-hop examples)
- Query examples (simple 2-hop, complex 3-hop)
- Performance characteristics
- Debugging tips for 3-level federation
- Troubleshooting multi-level failures
- Code examples for each pattern

#### Step 4: Create Test Runner Script
Create `/home/lionel/code/fraiseql/tests/integration/run_3subgraph_tests.sh`

**Features**:
- Start Docker Compose (with 3 databases)
- Wait for all services including products subgraph
- Run all `test_three_subgraph_` tests
- Provide colored output and summary
- Handle cleanup

#### Step 5: Verification & Testing
- [ ] All test code compiles without warnings
- [ ] Each test scenario executes without errors
- [ ] Docker Compose up/down works correctly
- [ ] Performance targets met (< 5s for full 3-hop)
- [ ] Documentation is comprehensive
- [ ] Test runner script is executable

#### Step 6: Git Commit
```bash
git add -A && git commit -m "feat(federation): Implement 3+ subgraph federation tests

Implemented 10 comprehensive 3-subgraph federation test scenarios..."
```

### Code Structure

```rust
// Add to federation_docker_compose_integration.rs before "Integration Test Suite" section

#[tokio::test]
#[ignore]
async fn test_three_subgraph_setup_validation() {
    // Validate all 3 services ready
}

#[tokio::test]
#[ignore]
async fn test_three_subgraph_direct_queries() {
    // Query products directly
}

// ... 8 more test scenarios

// Update setup_federation_tests() or create new helper:
#[allow(dead_code)]
async fn setup_three_subgraph_tests() -> Result<(), Box<dyn std::error::Error>> {
    // Wait for users, orders, products, gateway
}
```

### Expected Outcomes

**On Success**:
- 10 new test scenarios passing
- Products subgraph fully integrated
- 3-hop federation validated
- Documentation complete
- ~850 lines of new code (tests + docs + runner)

**On Partial Success**:
- Some tests may indicate missing features (acceptable for MVP)
- Can mark as "expected" failures if infrastructure ready
- Document what's needed for full implementation

### Dependencies
- Docker Compose environment running
- Products subgraph healthy
- All previous tests still passing
- Federation configuration in place

### Files to Create/Modify
1. **MODIFY**: `crates/fraiseql-core/tests/federation_docker_compose_integration.rs`
   - Add 10 test scenarios (~650 lines)
   - Add `setup_three_subgraph_tests()` helper

2. **CREATE**: `tests/integration/3SUBGRAPH_FEDERATION.md` (~350 lines)
   - Complete architecture and test documentation

3. **CREATE**: `tests/integration/run_3subgraph_tests.sh`
   - Automated test runner script

4. **MAYBE MODIFY**: `tests/integration/docker-compose.yml`
   - Verify products service is fully configured
   - Add products to Apollo Router configuration if needed

---

## Task #6: Apollo Router Schema Composition (If Time Permits)

### Overview
Verify Apollo Router can properly compose schemas from all 3 subgraphs and validate gateway behavior.

### High-Level Checklist
- [ ] Verify Apollo Router discovers all 3 subgraphs
- [ ] Check SDL endpoint returns complete schema
- [ ] Validate federation directives in composed schema
- [ ] Test query planning with composite queries
- [ ] Verify gateway can route to correct subgraph
- [ ] Test error handling from subgraph failures

### Tests to Implement
1. `test_apollo_router_discovers_subgraphs`
2. `test_apollo_router_schema_composition`
3. `test_apollo_router_sdl_completeness`
4. `test_apollo_router_federation_directives`
5. `test_apollo_router_query_routing`
6. `test_apollo_router_error_handling`

### Documentation
Create `/home/lionel/code/fraiseql/tests/integration/APOLLO_ROUTER.md`

---

## Detailed Work Instructions

### Morning (Start of Day)
1. Review current test file structure
   ```bash
   wc -l /home/lionel/code/fraiseql/crates/fraiseql-core/tests/federation_docker_compose_integration.rs
   tail -100 [file]  # See where to add new tests
   ```

2. Verify Docker Compose products service is ready
   ```bash
   cd /home/lionel/code/fraiseql/tests/integration
   docker-compose ps
   # Verify products-subgraph is listed
   ```

3. Test products subgraph manually
   ```bash
   curl -X POST http://localhost:4003/graphql \
     -H "Content-Type: application/json" \
     -d '{"query": "{ __typename }"}'
   ```

### Mid-Morning (Implement Tests)
1. Add `setup_three_subgraph_tests()` helper to test file
2. Implement tests 1-5 (core functionality)
3. Run compilation check every few tests
4. Commit partial progress if needed

### Late Morning (Complete Tests & Documentation)
1. Implement tests 6-10 (federation & performance)
2. Create 3SUBGRAPH_FEDERATION.md
3. Create run_3subgraph_tests.sh script
4. Test script execution manually

### Afternoon (Verification & Polish)
1. Run full test suite
2. Fix any compilation errors
3. Update documentation based on actual behavior
4. Final git commit
5. If time: Start Task #6 planning

---

## Success Criteria for Tomorrow

### Task #5 Complete When:
- [ ] 10 test scenarios implemented
- [ ] All tests compile without warnings
- [ ] Tests execute (may fail if features not ready)
- [ ] 3SUBGRAPH_FEDERATION.md written (~350 lines)
- [ ] run_3subgraph_tests.sh created and executable
- [ ] Commit message clear and comprehensive
- [ ] Documentation includes architecture diagrams
- [ ] Query examples provided for each pattern
- [ ] Performance benchmarks defined
- [ ] Debugging guide included

### Code Quality Requirements:
- [ ] No compiler warnings
- [ ] Consistent error handling
- [ ] Proper test assertions
- [ ] Clear test names and descriptions
- [ ] Comprehensive documentation
- [ ] Executable shell scripts

---

## Testing Checklist (During Implementation)

### After Each Test Scenario
```bash
# Compile check
cargo test --test federation_docker_compose_integration --no-run

# Verify no clippy warnings
cargo clippy --all-targets --all-features

# Check line count
wc -l crates/fraiseql-core/tests/federation_docker_compose_integration.rs
```

### Before Final Commit
```bash
# Full test compilation
cargo test --test federation_docker_compose_integration --no-run

# Verify documentation files
wc -l tests/integration/3SUBGRAPH_FEDERATION.md
wc -l tests/integration/run_3subgraph_tests.sh

# Check script is executable
ls -l tests/integration/run_3subgraph_tests.sh

# Verify git status
git status

# Show what will be committed
git diff --cached --stat
```

---

## Architecture Reference

### Current Progress
```
Users (4001) â†â†’ Orders (4002) â†â†’ Products (4003)
    â†“               â†“                  â†“
  Users DB       Orders DB        Products DB

Apollo Router (4000) - Composes all 3
```

### 3-Hop Query Pattern (To Test)
```graphql
query {
    users(limit: 2) {
        id                           # From users subgraph
        identifier
        orders {                     # Extended from orders subgraph
            id
            status
            products {               # Extended from products subgraph
                id
                name
                price
            }
        }
    }
}
```

### Entity Resolution Chain
```
User (owned by users)
  â†’ extended in orders subgraph
    â†’ orders reference products
      â†’ products (owned by products subgraph)

Resolution path:
Gateway â†’ Users â†’ Orders (resolve orders) â†’ Products (resolve products)
```

---

## Potential Issues & Mitigations

### Issue: Products subgraph not starting
**Mitigation**:
- Check docker-compose.yml products service configuration
- Verify PostgreSQL port 5434 is available
- Check service logs: `docker-compose logs products-subgraph`

### Issue: Apollo Router not discovering products subgraph
**Mitigation**:
- Verify products service health: `curl http://localhost:4003/graphql`
- Check router config references products service
- Verify federation metadata in products schema

### Issue: 3-hop queries timeout
**Mitigation**:
- Start with smaller batches (1-2 users)
- Increase timeout in test if needed
- Profile individual subgraph latency
- Check cross-service network connectivity

### Issue: Tests fail but infrastructure seems OK
**Mitigation**:
- Mark as "expected failures" if feature not implemented
- Document what's needed for full support
- Create issue for future implementation
- Don't block on completing tests if MVP ready

---

## Files to Watch

### Primary Files
- `crates/fraiseql-core/tests/federation_docker_compose_integration.rs` (main test file)
- `tests/integration/docker-compose.yml` (verify products config)
- `tests/integration/services/products/` (all products service files)

### Documentation Files
- `tests/integration/README.md` (main integration guide)
- `tests/integration/FEDERATION_TESTS.md` (2-subgraph guide)
- `tests/integration/EXTENDED_MUTATIONS.md` (mutation guide)
- `tests/integration/COMPOSITE_KEYS.md` (composite keys guide)
- **NEW**: `tests/integration/3SUBGRAPH_FEDERATION.md` (to create)

### Test Runners
- `tests/integration/run_2subgraph_tests.sh`
- `tests/integration/run_extended_mutation_tests.sh`
- `tests/integration/run_composite_key_tests.sh`
- **NEW**: `tests/integration/run_3subgraph_tests.sh` (to create)

---

## Timeline Estimate (Without Time Estimates)

### Morning Session
1. Review and verify products setup
2. Write setup helper and tests 1-3
3. Compile and verify

### Afternoon Session
1. Complete tests 4-10
2. Write documentation
3. Create test runner
4. Final verification and commit

### Optional Evening
1. Start Task #6 planning
2. Or: Deep dive on any blocking issues

---

## Git Workflow for Tomorrow

```bash
# Start of day
git status
git log --oneline -5

# After Task #5 tests complete
git add crates/fraiseql-core/tests/federation_docker_compose_integration.rs
git add tests/integration/3SUBGRAPH_FEDERATION.md
git add tests/integration/run_3subgraph_tests.sh
git commit -m "feat(federation): Implement 3+ subgraph federation tests

[comprehensive commit message as per format]"

# If Task #6 started
git add [task #6 files]
git commit -m "feat(federation): Implement Apollo Router verification tests

[message for task #6]"
```

---

## Quick Reference: Key Commands

### Test Compilation
```bash
cargo test --test federation_docker_compose_integration --no-run 2>&1 | tail -10
```

### Docker Compose Health
```bash
cd /home/lionel/code/fraiseql/tests/integration
docker-compose ps
docker-compose logs -f [service-name]
```

### Manual API Testing
```bash
# Products subgraph
curl -X POST http://localhost:4003/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __typename }"}'

# Apollo Router
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __typename }"}'
```

### Test Execution
```bash
# All 3-subgraph tests
cargo test test_three_subgraph_ --ignored --nocapture

# Single test
cargo test test_three_subgraph_federation_users_orders_products --ignored --nocapture
```

### Line Counts
```bash
wc -l crates/fraiseql-core/tests/federation_docker_compose_integration.rs
find tests/integration -name "*.md" -exec wc -l {} \;
```

---

## Notes for Tomorrow

### Remember
- Tests marked `#[ignore]` run with `--ignored` flag
- Each test should be independent (can run in any order)
- Error messages should be helpful for debugging
- Documentation should include working examples
- Performance targets are guidelines, not hard requirements

### Best Practices
- Add one test, compile, verify, commit
- Use existing helpers (setup_federation_tests, graphql_query, etc.)
- Keep tests focused on single scenario
- Document expected vs actual behavior
- Handle both success and "not yet implemented" gracefully

### Documentation Quality
- Include ASCII architecture diagrams
- Provide working curl examples
- Explain federation flow at each hop
- Document expected latency
- Include troubleshooting section
- Add links to other federation docs

---

## Success Summary for EOD 2026-01-28

If all goes well, tomorrow's deliverables:
- âœ… Task #5 complete (10 new tests, ~850 lines)
- âœ… 3+ subgraph federation validated
- âœ… Comprehensive documentation added
- âœ… Test runner script working
- âœ… All code commits clean with good messages

**Total code by EOD**: 5,181+ lines (5/8 tasks complete, 62.5%)

If Task #6 started:
- ðŸš€ Apollo Router validation tests sketched
- ðŸš€ Test implementation started
- ðŸš€ Partial progress toward schema composition tests
