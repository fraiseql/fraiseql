name: Security & Compliance

# Comprehensive security and compliance checks
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:

concurrency:
  group: security-compliance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install license scanning tools
      run: |
        uv venv
        uv pip install pip-licenses

    - name: Scan Python package licenses
      run: |
        echo "=== Python Package Licenses ==="
        uv run pip-licenses --format=markdown --output-file=python-licenses.md
        cat python-licenses.md

    - name: Check for GPL licenses
      run: |
        # Check for GPL licenses (excluding LGPL which is more permissive)
        if grep -i "GPL" python-licenses.md | grep -v -i "LGPL"; then
          echo "‚ùå GPL-licensed packages found (excluding LGPL):"
          grep -i "GPL" python-licenses.md | grep -v -i "LGPL"
          exit 1
        elif grep -i "LGPL" python-licenses.md; then
          echo "‚ö†Ô∏è  LGPL-licensed packages found - these are acceptable"
          grep -i "LGPL" python-licenses.md
        else
          echo "‚úÖ No GPL licenses found"
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v5
      with:
        name: license-report
        path: python-licenses.md

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build test container
      run: |
        docker build -f deploy/docker/Dockerfile -t fraiseql:test .

    - name: Scan container with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'image'
        scan-ref: 'fraiseql:test'
        format: 'sarif'
        output: 'trivy-container-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: 1

    - name: Upload Trivy container scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-container-results.sarif'

    - name: Container Security Scan
      run: |
        echo "‚úÖ Container security scanning completed with Trivy above"
        echo "Dockle scan removed - Trivy provides comprehensive container scanning"

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Audit Python dependencies
      run: |
        uv venv
        uv pip install ".[dev,all]"
        uv run pip-audit --format json --output audit-results.json || true

    - name: Check for critical vulnerabilities
      run: |
        if [ -f audit-results.json ]; then
          # Check for CRITICAL or HIGH severity vulnerabilities
          if jq -e '.vulnerabilities[] | select(.severity == "CRITICAL" or .severity == "HIGH")' audit-results.json > /dev/null; then
            echo "üö® Critical or high-severity vulnerabilities found!"
            jq '.vulnerabilities[] | select(.severity == "CRITICAL" or .severity == "HIGH")' audit-results.json
            exit 1
          else
            echo "‚úÖ No critical or high-severity vulnerabilities found"
          fi
        else
          echo "‚ö†Ô∏è  pip-audit did not generate results file"
        fi

    - name: Upload audit results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: dependency-audit-results
        path: audit-results.json

  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Check security policy exists
      run: |
        if [ ! -f "SECURITY.md" ]; then
          echo "‚ùå SECURITY.md file is missing"
          exit 1
        fi
        echo "‚úÖ Security policy exists"

    - name: Check for security headers in nginx config
      run: |
        if grep -q "add_header X-Frame-Options" deploy/nginx-fraiseql.conf; then
          echo "‚úÖ Security headers found in nginx config"
        else
          echo "‚ö†Ô∏è  Security headers not found in nginx config"
        fi

    - name: Validate secrets are not committed
      run: |
        # Check for common secret patterns (excluding legitimate code patterns)
        if grep -r -i "password\|secret\|token" --include="*.py" --include="*.yml" --include="*.yaml" src/ | \
           grep -v "test\|example\|mock\|fake\|KeyError\|error_keywords\|raise.*Error\|api_key\|apikey\|auth_token" | \
           grep -v "test.*key\|key.*test\|example.*key\|key.*example"; then
          echo "‚ö†Ô∏è  Potential secrets found in source code:"
          grep -r -i "password\|secret\|token" --include="*.py" --include="*.yml" --include="*.yaml" src/ | \
            grep -v "test\|example\|mock\|fake\|KeyError\|error_keywords\|raise.*Error\|api_key\|apikey\|auth_token" | \
            grep -v "test.*key\|key.*test\|example.*key\|key.*example"
          exit 1
        fi
        echo "‚úÖ No obvious secrets found in source code"

    - name: Check for required security files
      run: |
        required_files=("SECURITY.md" "LICENSE" "CODE_OF_CONDUCT.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file $file is missing"
            exit 1
          fi
        done
        echo "‚úÖ All required security and compliance files present"

  security-gate:
    name: Security Gate ‚úÖ
    runs-on: ubuntu-latest
    needs: [secrets-scan, license-scan, container-security, dependency-audit, compliance-check]
    if: always()
    steps:
      - name: Security compliance check
        run: |
          # Check if all security jobs passed
          if [[ "${{ needs.secrets-scan.result }}" != "success" ]]; then
            echo "‚ùå Secrets scan failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.license-scan.result }}" != "success" ]]; then
            echo "‚ùå License compliance failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.container-security.result }}" != "success" ]]; then
            echo "‚ùå Container security scan failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.dependency-audit.result }}" != "success" ]]; then
            echo "‚ùå Dependency audit failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.compliance-check.result }}" != "success" ]]; then
            echo "‚ùå Compliance validation failed - Security gate blocked"
            exit 1
          fi
          echo "‚úÖ All security and compliance checks passed - Security gate open"
          echo "üîí Code meets security and compliance standards"
