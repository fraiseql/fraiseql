name: Quality Gate

# Optimized CI workflow that splits tests for faster feedback
# Fast unit tests run first, integration tests only if unit tests pass
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF to Code Scanning
  actions: read

jobs:
  unit-tests:
    name: Unit Tests (Fast)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: uv-${{ runner.os }}-py3.13-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          uv-${{ runner.os }}-py3.13-

    - name: Setup environment and install dependencies
      env:
        FRAISEQL_SKIP_RUST: 1
      run: |
        # Create virtual environment with uv
        uv venv

        # Install build dependencies first (required for some packages like thrift)
        uv pip install setuptools wheel

        # Install all dependencies (Rust extension will be skipped due to FRAISEQL_SKIP_RUST=1)
        uv pip install ".[dev,all]"

    - name: Verify Environment
      env:
        FRAISEQL_SKIP_RUST: 1
      run: |
        echo "=== Environment Verification ==="
        uv run python --version
        uv --version
        uv run pytest --version
        echo "‚úÖ Environment ready (no database, no Rust)"

    - name: Run fast unit tests
      env:
        FRAISEQL_SKIP_RUST: 1
      run: |
        echo "=== Running Fast Unit Tests ==="
        uv run pytest tests/ \
          -m 'not database and not integration and not e2e and not forked and not slow and not enterprise' \
          --cov=src/fraiseql \
          --cov-report=xml \
          --cov-report=term-missing \
          -v \
          --tb=short \
          --disable-warnings \
          || {
            echo "‚ùå Unit tests failed"
            exit 1
          }
        echo "‚úÖ Unit tests completed successfully"

    - name: Upload coverage
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: unittests
        name: Python-3.13-Unit
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  integration-tests:
    name: Integration Tests (Slow)
    runs-on: ubuntu-latest
    needs: [unit-tests, lint]

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: fraiseql
          POSTGRES_PASSWORD: fraiseql
          POSTGRES_DB: fraiseql_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # Vault service temporarily disabled due to GitHub Actions container startup issues
      # See "Initialize Vault for KMS tests" step comment below for detailed explanation
      # vault:
      #   image: hashicorp/vault:latest
      #   env:
      #     VAULT_DEV_ROOT_TOKEN_ID: fraiseql-ci-token
      #     VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      #   ports:
      #     - 8200:8200
      #   options: >-
      #     --cap-add=IPC_LOCK
      #     --health-cmd "vault status"
      #     --health-interval 10s
      #     --health-timeout 5s
      #     --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Cache Rust build
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          fraiseql_rs/target/
        key: rust-${{ runner.os }}-${{ hashFiles('fraiseql_rs/Cargo.lock') }}
        restore-keys: |
          rust-${{ runner.os }}-

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Install maturin
      run: uv tool install maturin

    - name: Setup environment and install dependencies
      run: |
        # Create virtual environment with uv
        uv venv

        # Install build dependencies first (required for some packages like thrift)
        uv pip install setuptools wheel

        # Install all dependencies
        uv pip install ".[dev,all]"

        # Build and install Rust extension with modern maturin+uv integration
        uv run maturin develop --uv

    - name: Check test collection performance
      env:
        FRAISEQL_SKIP_RUST: 1
      run: |
        echo '=== Test Collection Performance Check ==='
        START_TIME=$(date +%s.%N)
        TEST_COUNT=$(uv run pytest tests/ --collect-only -q -m 'not database and not integration and not e2e and not forked and not slow and not enterprise' 2>/dev/null | tail -1 | grep -oE '[0-9]+' | head -1 || echo '0')
        END_TIME=$(date +%s.%N)
        COLLECTION_TIME=$(echo "$END_TIME - $START_TIME" | bc)
        echo "Unit tests collected: $TEST_COUNT tests in ${COLLECTION_TIME}s"

        # Fail if collection takes >15 seconds (regression)
        if (( $(echo "$COLLECTION_TIME > 15" | bc -l) )); then
          echo '‚ùå Test collection took too long (>15s) - possible performance regression'
          exit 1
        fi
        echo '‚úÖ Test collection performance OK'

    - name: Verify Environment
      run: |
        echo "=== Environment Verification ==="
        uv run python --version
        uv --version
        uv run pytest --version
        rustc --version
        pg_isready -h localhost -p 5432 -U fraiseql && echo '‚úÖ PostgreSQL Ready' || echo '‚ùå PostgreSQL Not Ready'
        uv run python -c "import psycopg; conn = psycopg.connect('postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test'); print('‚úÖ DB connection successful'); conn.close()" || echo "‚ùå DB connection failed"
        echo "=== Database Extensions Setup ==="
        uv run python -c "
        import psycopg
        # Connect as postgres user to create extensions
        try:
            conn = psycopg.connect('postgresql://postgres@localhost:5432/fraiseql_test')
            conn.execute('CREATE EXTENSION IF NOT EXISTS vector')
            conn.commit()
            print('‚úÖ pgvector extension created')
            conn.close()
        except Exception as e:
            print(f'Failed to connect as postgres: {e}')
            # Try connecting as fraiseql and create extension if possible
            try:
                conn = psycopg.connect('postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test')
                conn.execute('CREATE EXTENSION IF NOT EXISTS vector')
                conn.commit()
                print('‚úÖ pgvector extension created as fraiseql user')
                conn.close()
            except Exception as e2:
                print(f'‚ùå Failed to create pgvector extension: {e2}')
        " || echo "‚ùå Failed to create pgvector extension"
        echo "=== Rust Extension Verification ==="
        uv run python -c "from fraiseql import fraiseql_rs; print(f'‚úÖ fraiseql_rs module imported'); print(f'   Has build_graphql_response: {hasattr(fraiseql_rs, \"build_graphql_response\")}'); print(f'   Functions available: {[f for f in dir(fraiseql_rs) if not f.startswith(\"_\")]}')" || echo "‚ùå fraiseql_rs import failed"

    # NOTE: KMS/Vault tests temporarily disabled in GitHub Actions due to container startup issues
    # The Vault container experiences intermittent health check failures in GitHub Actions infrastructure
    # causing the container to remain in "starting" state and eventually timeout as "unhealthy".
    # This is a known infrastructure limitation, not a code issue. Configuration follows HashiCorp best practices:
    # - Uses 'vault status' health check (recommended approach)
    # - Correct VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    # - Proper IPC_LOCK capability
    # KMS tests will automatically skip when VAULT_ADDR is not set (existing skipif decorator).
    # Tests work fine locally and can be re-enabled once GitHub Actions/Vault compatibility improves.
    # References:
    # - https://developer.hashicorp.com/vault/docs/platform/github-actions
    # - https://discuss.hashicorp.com/t/cant-access-ui-when-running-vault-in-dev-mode-from-docker/41521
    #
    # - name: Initialize Vault for KMS tests
    #   env:
    #     VAULT_ADDR: http://localhost:8200
    #     VAULT_TOKEN: fraiseql-ci-token
    #   run: |
    #     echo "=== Initializing Vault for KMS Tests ==="
    #     # Wait for Vault to be ready
    #     timeout 30 bash -c 'until curl -s http://localhost:8200/v1/sys/health; do sleep 1; done' || (echo "‚ùå Vault not ready" && exit 1)
    #     echo "‚úÖ Vault is ready"
    #
    #     # Enable transit engine
    #     curl -X POST -H "X-Vault-Token: $VAULT_TOKEN" \
    #       http://localhost:8200/v1/sys/mounts/transit \
    #       -d '{"type":"transit"}' || (echo "‚ùå Failed to enable transit engine" && exit 1)
    #     echo "‚úÖ Transit engine enabled"
    #
    #     # Create test keys
    #     for key in test-integration-key test-data-key test-key-1 test-key-2; do
    #       curl -X POST -H "X-Vault-Token: $VAULT_TOKEN" \
    #         http://localhost:8200/v1/transit/keys/$key || (echo "‚ùå Failed to create key $key" && exit 1)
    #     done
    #     echo "‚úÖ Test keys created"

    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test
        TEST_DATABASE_URL: postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test
        # VAULT_ADDR: http://localhost:8200  # Disabled - see Vault initialization comment above
        # VAULT_TOKEN: fraiseql-ci-token  # Disabled - see Vault initialization comment above
        # VAULT_TRANSIT_MOUNT: transit  # Disabled - see Vault initialization comment above
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: fraiseql
        DB_PASSWORD: fraiseql
        FRAISEQL_ENVIRONMENT: ci
        FRAISEQL_AUTO_INSTALL: false
        FRAISEQL_LOG_LEVEL: INFO
        PYTEST_CURRENT_TEST: ""
      run: |
        echo "=== Running Integration Tests ==="
        echo "Environment variables:"
        printenv | grep -E "(DATABASE_URL|DB_|PYTEST_)" || echo "No relevant env vars"
        echo "Running pytest with integration markers..."

        uv run pytest tests/ \
          -m 'database or integration or e2e or forked or slow or enterprise' \
          --cov=src/fraiseql \
          --cov-report=xml \
          --cov-report=term-missing \
          -v \
          --tb=short \
          --disable-warnings \
          || {
            echo "‚ùå Integration tests failed"
            exit 1
          }
        echo "‚úÖ Integration tests completed successfully"

    - name: Validate Network Filtering Fix
      env:
        DATABASE_URL: postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test
        TEST_DATABASE_URL: postgresql://fraiseql:fraiseql@localhost:5432/fraiseql_test
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: fraiseql
        DB_PASSWORD: fraiseql
      run: |
        echo "=== Validating Network Filtering Bug Fix ==="
        echo "This validates the core bug fix from PR #25"

        echo "Testing JSONB network filtering bug fix..."
        uv run pytest tests/integration/database/sql/test_jsonb_network_filtering_bug.py -v --tb=short || {
          echo "‚ùå CRITICAL: Network filtering tests failed!"
          echo "This indicates the core bug fix from PR #25 is broken"
          exit 1
        }

        echo "Testing network address filtering functionality..."
        uv run pytest tests/integration/database/sql/test_network_address_filtering.py -v --tb=short || {
          echo "‚ùå CRITICAL: Network address filtering tests failed!"
          echo "This indicates the core bug fix from PR #25 is broken"
          exit 1
        }

        echo "‚úÖ Network filtering bug fix validated successfully"

    - name: Upload coverage
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: integration
        name: Python-3.13-Integration
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    - name: Install dependencies
      run: |
        uv venv
        uv pip install ruff
    - name: Run ruff check (includes type checking)
      run: uv run ruff check .
    - name: Run ruff format check
      run: uv run ruff format --check .

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    - name: Install dependencies
      run: |
        uv venv
        uv pip install bandit safety
    - name: Run bandit security scan
      run: |
        uv run bandit -r src/ -f json -o bandit-results.json || true
        echo "=== Security Module Specific Scan ==="
        uv run bandit -r src/fraiseql/security/ -ll -f txt -o security-module-scan.txt || true
    - name: Run safety dependency vulnerability scan
      run: uv run safety check --output json --save-json safety-results.json || true
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'FraiseQL'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental
          --nvdValidForHours 24
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    - name: Archive security scan results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: security-scan-results
        path: |
          bandit-results.json
          safety-results.json
          reports/

  quality-gate:
    name: Quality Gate ‚úÖ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, lint, security]
    if: always()
    steps:
      - name: Check quality gate status
        run: |
          # This job will fail if any of the required jobs failed
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "‚ùå Unit tests failed - Quality gate blocked"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "‚ùå Integration tests failed - Quality gate blocked"
            exit 1
          fi
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "‚ùå Lint checks failed - Quality gate blocked"
            exit 1
          fi
          if [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "‚ùå Security checks failed - Quality gate blocked"
            exit 1
          fi
          echo "‚úÖ All quality checks passed - Quality gate open"
          echo "üöÄ Code is ready for merge/release"
