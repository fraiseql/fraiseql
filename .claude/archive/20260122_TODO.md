# FraiseQL Phase 6 - Day 2 TODO (2026-01-22)

## Overview
Phase 6 Observer System is 76% complete (5/8 subphases done). Today's focus: Complete remaining subphases (6.5-6.8) and prepare for Phase 7.

**Current Status:**
- âœ… 6.0: Foundation & Testing Seams (26 tests)
- âœ… 6.1: Event Plumbing (10 tests)
- âœ… 6.2: Condition Evaluator (14 tests)
- âœ… 6.3: Core Actions (7 tests)
- âœ… 6.4: Executor & Orchestration (9 tests)
- ðŸ”² 6.5: Additional Actions (SMS, Push, Search, Cache) - 3 hours
- ðŸ”² 6.6: Database & Schema - 1 hour
- ðŸ”² 6.7: Comprehensive Tests - 6 hours
- ðŸ”² 6.8: Documentation & Polish - 2 hours

**Test Summary:** 66/66 passing (100%)
**Lines of Code:** 4,672 LOC (Rust, zero unsafe)

---

## Morning Session (6.5-6.6)

### Subphase 6.5: Additional Actions (SMS, Push, Search, Cache)
**File:** `crates/fraiseql-observers/src/actions_additional.rs`
**Duration:** 3 hours
**Expected Tests:** 8-10 new tests (total: 74-76)

#### Tasks:
1. **SMS Action**
   - [ ] Create `SmsAction` struct with async execute method
   - [ ] Support phone number from config or template
   - [ ] Message template rendering
   - [ ] Stub implementation (full implementation in future phase)
   - [ ] Tests: 2 (creation, execute)

2. **Push Notification Action**
   - [ ] Create `PushAction` struct
   - [ ] Support device_token configuration
   - [ ] Title and body template rendering
   - [ ] Stub implementation (Firebase/APNs integration later)
   - [ ] Tests: 2 (creation, execute)

3. **Search Index Action**
   - [ ] Create `SearchAction` struct
   - [ ] Support index name and document ID template
   - [ ] Action types: index, update, delete operations
   - [ ] Stub implementation (Elasticsearch/OpenSearch integration later)
   - [ ] Tests: 2 (creation, execute)

4. **Cache Invalidation Action**
   - [ ] Create `CacheAction` struct
   - [ ] Support key pattern matching
   - [ ] Action types: invalidate, refresh
   - [ ] Stub implementation (Redis/Memcached integration later)
   - [ ] Tests: 2 (creation, execute)

5. **Update executor.rs**
   - [ ] Add match arms for new action types
   - [ ] Handle environment variable resolution
   - [ ] Error handling for unsupported types (should now support all Phase 6 actions)
   - [ ] Tests: Updated process_event test to cover new actions

6. **Update lib.rs**
   - [ ] Export new action types: `SmsAction`, `PushAction`, `SearchAction`, `CacheAction`
   - [ ] Re-export from `actions_additional` module

#### Success Criteria:
- [ ] All new action types compile
- [ ] 8-10 new tests passing
- [ ] No existing tests broken
- [ ] Executor handles all action types gracefully

---

### Subphase 6.6: Database & Schema
**Duration:** 1 hour
**Expected Tests:** Integration/schema tests (not unit tests)

#### Tasks:
1. **Create migrations file**
   - [ ] `crates/fraiseql-observers/migrations/01_create_dlq_schema.sql`
   - [ ] Tables needed:
     - `observer_events` (event log for debugging)
     - `observer_dlq_items` (dead letter queue)
     - `observer_dlq_history` (retry history)

2. **Schema Design**

   **observer_events table:**
   ```sql
   CREATE TABLE observer_events (
       id UUID PRIMARY KEY,
       event_type VARCHAR(50) NOT NULL,
       entity_type VARCHAR(100) NOT NULL,
       entity_id UUID NOT NULL,
       data JSONB NOT NULL,
       created_at TIMESTAMP WITH TIME ZONE NOT NULL,
       processed_at TIMESTAMP WITH TIME ZONE,
       status VARCHAR(50) DEFAULT 'pending'
   );
   CREATE INDEX idx_observer_events_entity ON observer_events(entity_type, event_type);
   ```

   **observer_dlq_items table:**
   ```sql
   CREATE TABLE observer_dlq_items (
       id UUID PRIMARY KEY,
       event_id UUID NOT NULL REFERENCES observer_events(id),
       action_type VARCHAR(50) NOT NULL,
       action_config JSONB NOT NULL,
       error_message TEXT NOT NULL,
       attempt_count INT DEFAULT 1,
       max_attempts INT DEFAULT 3,
       created_at TIMESTAMP WITH TIME ZONE NOT NULL,
       last_retry_at TIMESTAMP WITH TIME ZONE,
       status VARCHAR(50) DEFAULT 'pending'
   );
   CREATE INDEX idx_observer_dlq_items_status ON observer_dlq_items(status);
   CREATE INDEX idx_observer_dlq_items_created ON observer_dlq_items(created_at);
   ```

   **observer_dlq_history table:**
   ```sql
   CREATE TABLE observer_dlq_history (
       id BIGSERIAL PRIMARY KEY,
       dlq_item_id UUID NOT NULL REFERENCES observer_dlq_items(id),
       attempt_number INT NOT NULL,
       error_message TEXT NOT NULL,
       executed_at TIMESTAMP WITH TIME ZONE NOT NULL,
       result VARCHAR(50) NOT NULL
   );
   CREATE INDEX idx_observer_dlq_history_item ON observer_dlq_history(dlq_item_id);
   ```

3. **Update config.rs (if needed)**
   - [ ] Add database connection configuration
   - [ ] Update `ObserverRuntimeConfig` with database settings

4. **Document schema**
   - [ ] Add comments in migration file
   - [ ] Document in README

#### Success Criteria:
- [ ] Migration file is syntactically correct SQL
- [ ] All three tables created with proper indexes
- [ ] Foreign key relationships established
- [ ] Ready for Phase 6.7 integration tests

---

## Afternoon Session (6.7-6.8)

### Subphase 6.7: Comprehensive Integration Tests
**Duration:** 6 hours
**Target:** 60+ new tests
**Expected Total:** 130+ tests passing

#### Test Categories:

1. **End-to-End Workflows (15 tests)**
   - [ ] Test 1: Simple webhook action executes successfully
   - [ ] Test 2: Slack action sends message with template substitution
   - [ ] Test 3: Condition failure skips observer
   - [ ] Test 4: Multiple observers on single event
   - [ ] Test 5: Multiple actions per observer execute in sequence
   - [ ] Test 6: Exponential backoff retries work correctly
   - [ ] Test 7: Linear backoff retries work correctly
   - [ ] Test 8: Fixed backoff retries work correctly
   - [ ] Test 9: Transient error triggers retry, permanent error goes to DLQ
   - [ ] Test 10: Failed action with DLQ policy moves to queue
   - [ ] Test 11: Failed action with Log policy logs error
   - [ ] Test 12: Failed action with Alert policy logs alert
   - [ ] Test 13: Multiple events processed independently
   - [ ] Test 14: Event matching performance (1000 observers)
   - [ ] Test 15: Condition evaluation with complex DSL

2. **Action-Specific Tests (20 tests)**
   - [ ] Webhook with environment variable URL resolution
   - [ ] Webhook with custom headers applied correctly
   - [ ] Webhook body template substitution
   - [ ] Webhook error handling (timeout, connection refused)
   - [ ] Slack with template substitution
   - [ ] Slack with optional channel override
   - [ ] Slack error handling
   - [ ] Email template rendering
   - [ ] Email address resolution
   - [ ] SMS stub execution
   - [ ] SMS error handling
   - [ ] Push notification execution
   - [ ] Push template rendering
   - [ ] Search index action
   - [ ] Cache invalidation action
   - [ ] Cache refresh action
   - [ ] Multiple action types in sequence
   - [ ] Action timeout handling
   - [ ] Action resource cleanup
   - [ ] Action metrics collection

3. **Condition Evaluation Tests (12 tests)**
   - [ ] Simple field comparison
   - [ ] Complex nested condition
   - [ ] Field change detection
   - [ ] Field changed_to detection
   - [ ] has_field() check
   - [ ] Logical AND short-circuit evaluation
   - [ ] Logical OR short-circuit evaluation
   - [ ] Logical NOT operator
   - [ ] Parentheses grouping
   - [ ] Mixed operators with precedence
   - [ ] Condition evaluation errors reported
   - [ ] Invalid condition syntax rejected

4. **Retry Logic Tests (10 tests)**
   - [ ] Retry on transient error
   - [ ] No retry on permanent error
   - [ ] Max attempts respected
   - [ ] Exponential backoff calculation
   - [ ] Linear backoff calculation
   - [ ] Fixed backoff calculation
   - [ ] Backoff max_delay cap applied
   - [ ] Retry with event mutation (field changed)
   - [ ] Retry counter incremented
   - [ ] Exhausted retries go to DLQ

5. **Dead Letter Queue Tests (8 tests)**
   - [ ] Failed action pushed to DLQ
   - [ ] DLQ item contains correct metadata
   - [ ] DLQ item retrievable by status
   - [ ] DLQ item marked as success
   - [ ] DLQ item marked as retry failed
   - [ ] DLQ history tracking retry attempts
   - [ ] DLQ handles concurrent pushes
   - [ ] DLQ persistence across restarts

6. **Event Matching Tests (5 tests)**
   - [ ] No matching observers returns empty
   - [ ] Single matching observer found
   - [ ] Multiple observers matched
   - [ ] Observer matched by entity_type
   - [ ] Observer matched by event_type

7. **Error Handling Tests (8 tests)**
   - [ ] Invalid condition syntax error
   - [ ] Missing action configuration error
   - [ ] Invalid action type error
   - [ ] HTTP connection error handling
   - [ ] Timeout error handling
   - [ ] JSON parsing error handling
   - [ ] Configuration validation error
   - [ ] Error reporting includes context

8. **Performance Tests (4 tests)**
   - [ ] Process 1000 events in < 5 seconds
   - [ ] 100 observers matched in < 100ms
   - [ ] Condition evaluation completes in < 10ms
   - [ ] Action execution duration tracked accurately

9. **Integration Tests (6 tests)**
   - [ ] Full pipeline: event â†’ listener â†’ matcher â†’ executor
   - [ ] Multiple observers with different conditions
   - [ ] Observer with all 3 action types
   - [ ] Backpressure handling with overflow policy
   - [ ] Graceful shutdown of executor
   - [ ] Listener reconnection on error

10. **Mock/Stub Tests (2 tests)**
    - [ ] Mock implementations work with real executor
    - [ ] Mock data collection accurate

#### File Structure:
```
tests/integration/
â”œâ”€â”€ mod.rs                       # Test harness
â”œâ”€â”€ workflows_test.rs            # End-to-end workflows
â”œâ”€â”€ actions_test.rs              # Action-specific tests
â”œâ”€â”€ conditions_test.rs           # Condition evaluation
â”œâ”€â”€ retries_test.rs              # Retry logic
â”œâ”€â”€ dlq_test.rs                  # Dead letter queue
â”œâ”€â”€ matching_test.rs             # Event matching
â”œâ”€â”€ errors_test.rs               # Error handling
â”œâ”€â”€ performance_test.rs          # Performance tests
â””â”€â”€ integration_test.rs          # Full pipeline tests
```

#### Test Utilities:
- [ ] Create test fixtures for events, observers, actions
- [ ] Helper functions for common test scenarios
- [ ] Mock HTTP server for webhook testing
- [ ] Test database setup/teardown

#### Success Criteria:
- [ ] All 60+ new tests passing
- [ ] Total test count: 126+ tests
- [ ] Test execution time: < 30 seconds
- [ ] No existing tests broken
- [ ] Code coverage: > 90%

---

### Subphase 6.8: Documentation & Polish
**Duration:** 2 hours

#### Tasks:

1. **Code Documentation (30 min)**
   - [ ] Add missing doc comments to all public items
   - [ ] Document all error codes with examples
   - [ ] Document all condition DSL functions
   - [ ] Document all backoff strategies
   - [ ] Document all failure policies
   - [ ] Fix all `missing_docs` warnings
   - [ ] Run: `cargo doc --open` and verify rendering

2. **Cleanup & Linting (20 min)**
   - [ ] Fix all clippy warnings
   - [ ] Remove unused imports (already done)
   - [ ] Format code: `cargo fmt`
   - [ ] Check formatting: `cargo fmt -- --check`
   - [ ] Verify no unsafe code remains
   - [ ] Run full lint: `cargo clippy --all-targets --all-features -- -D warnings`

3. **README & Examples (30 min)**
   - [ ] Create `README.md` for observer system
   - [ ] Document DSL syntax with examples
   - [ ] Document configuration schema
   - [ ] Document error codes and handling
   - [ ] Add architecture diagram
   - [ ] Document backoff strategies with examples
   - [ ] Document DLQ usage

4. **Code Quality Verification (20 min)**
   - [ ] Run full test suite
   - [ ] Verify all 126+ tests pass
   - [ ] Check code metrics
   - [ ] Verify memory usage reasonable
   - [ ] Check binary size

5. **Final Touches (20 min)**
   - [ ] Update root README to mention Phase 6
   - [ ] Update IMPLEMENTATION_ROADMAP
   - [ ] Final git commit
   - [ ] Verify branch ready for PR

#### Success Criteria:
- [ ] Zero clippy warnings (lint passes with -D warnings)
- [ ] All public items documented
- [ ] README complete with examples
- [ ] 126+ tests passing
- [ ] Ready for main branch merge

---

## Daily Checklist

### Morning (6.5-6.6):
- [ ] **6.5 Complete**: Additional actions implemented (SMS, Push, Search, Cache)
  - [ ] SmsAction created and tested (2 tests)
  - [ ] PushAction created and tested (2 tests)
  - [ ] SearchAction created and tested (2 tests)
  - [ ] CacheAction created and tested (2 tests)
  - [ ] Executor updated to handle new actions
  - [ ] 8-10 new tests passing
  - [ ] Commit: `feat(phase-6): Subphase 6.5 - Additional Actions`

- [ ] **6.6 Complete**: Database schema designed
  - [ ] Migration SQL written (observer_events, observer_dlq_items, observer_dlq_history)
  - [ ] Schema documented
  - [ ] Indexes defined
  - [ ] Foreign keys established
  - [ ] Commit: `feat(phase-6): Subphase 6.6 - Database Schema`

### Afternoon (6.7-6.8):
- [ ] **6.7 Complete**: 60+ integration tests written
  - [ ] End-to-end workflow tests (15)
  - [ ] Action-specific tests (20)
  - [ ] Condition evaluation tests (12)
  - [ ] Retry logic tests (10)
  - [ ] Dead Letter Queue tests (8)
  - [ ] Event matching tests (5)
  - [ ] Error handling tests (8)
  - [ ] Performance tests (4)
  - [ ] Integration tests (6)
  - [ ] Mock/stub tests (2)
  - [ ] 126+ total tests passing
  - [ ] Commit: `test(phase-6): Subphase 6.7 - Comprehensive Integration Tests`

- [ ] **6.8 Complete**: Documentation and polish
  - [ ] All doc comments added
  - [ ] All clippy warnings fixed
  - [ ] README written
  - [ ] Examples documented
  - [ ] Code formatted
  - [ ] Final verification
  - [ ] Commit: `docs(phase-6): Subphase 6.8 - Documentation & Polish`

---

## Expected Outcomes

### By End of Day:
- âœ… Phase 6 Complete (8/8 subphases)
- âœ… 126+ tests passing (100%)
- âœ… ~5,500 total lines of Rust code
- âœ… Zero unsafe code
- âœ… Zero clippy warnings
- âœ… Complete documentation
- âœ… Ready for Phase 7

### Ready for Phase 7:
- PostgreSQL observer system fully functional
- Can execute observers on real database mutations
- Complete retry and DLQ infrastructure
- Webhook, Slack, email delivery
- Additional actions available (SMS, Push, Search, Cache)

---

## Time Budget

| Subphase | Task | Duration | Status |
|----------|------|----------|--------|
| 6.5 | Additional actions | 3 hrs | ðŸ”² |
| 6.6 | Database schema | 1 hr | ðŸ”² |
| 6.7 | Integration tests | 6 hrs | ðŸ”² |
| 6.8 | Documentation | 2 hrs | ðŸ”² |
| **TOTAL** | **Phase 6 Completion** | **12 hrs** | ðŸ”² |

**Buffer:** 2 hours for unexpected issues
**Total Available:** 8 hours (end of day)
**Strategy:** Front-load 6.5-6.6 (4 hrs) morning, focus 6.7-6.8 (8 hrs) afternoon

---

## Notes for Tomorrow

1. **Test Writing**: Use existing test patterns from Phase 6.0-6.4
2. **Mock Usage**: Continue using mock implementations to avoid real HTTP/DB calls
3. **Commit Frequency**: Commit each subphase completion
4. **Testing**: Run full test suite after each subphase
5. **Documentation**: Write docs as you implement (not at the end)
6. **Focus**: Subphase 6.7 is the most time-intensive; prioritize quality tests

---

## Success Metrics for Tomorrow

- [ ] Phase 6 complete: 8/8 subphases done
- [ ] Tests: 126+ passing (100%)
- [ ] Code: Zero unsafe, zero clippy warnings
- [ ] Documentation: Complete with examples
- [ ] Ready: For Phase 7 or main branch merge
- [ ] Time: Complete within 8-hour day estimate
