version: '3.8'

services:
  flight-service:
    image: python:3.11
    working_dir: /app
    command: python -c "from flask import Flask, request, jsonify; app = Flask(__name__); @app.route('/graphql', methods=['POST']); def gql(): return jsonify({'data': {'reserveFlight': {'flightId': 'f-123', 'status': 'reserved'}}}); @app.route('/health'); def health(): return 'OK'; app.run('0.0.0.0', 4000)"
    ports:
      - "4001:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  hotel-service:
    image: python:3.11
    working_dir: /app
    command: python -c "from flask import Flask, request, jsonify; app = Flask(__name__); @app.route('/graphql', methods=['POST']); def gql(): return jsonify({'data': {'reserveHotel': {'hotelId': 'h-456', 'status': 'reserved'}}}); @app.route('/health'); def health(): return 'OK'; app.run('0.0.0.0', 4000)"
    ports:
      - "4002:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  car-service:
    image: python:3.11
    working_dir: /app
    command: python -c "from flask import Flask, request, jsonify; app = Flask(__name__); @app.route('/graphql', methods=['POST']); def gql(): return jsonify({'data': {'reserveCar': {'carId': 'c-789', 'status': 'reserved'}}}); @app.route('/health'); def health(): return 'OK'; app.run('0.0.0.0', 4000)"
    ports:
      - "4003:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment-service:
    image: python:3.11
    working_dir: /app
    command: python -c "from flask import Flask, request, jsonify; app = Flask(__name__); @app.route('/graphql', methods=['POST']); def gql(): return jsonify({'data': {'processPayment': {'chargeId': 'ch-999', 'status': 'completed'}}}); @app.route('/health'); def health(): return 'OK'; app.run('0.0.0.0', 4000)"
    ports:
      - "4004:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-service:
    image: python:3.11
    working_dir: /app
    command: python -c "from flask import Flask, request, jsonify; app = Flask(__name__); @app.route('/graphql', methods=['POST']); def gql(): return jsonify({'data': {'sendConfirmation': {'notificationId': 'n-111', 'status': 'sent'}}}); @app.route('/health'); def health(): return 'OK'; app.run('0.0.0.0', 4000)"
    ports:
      - "4005:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  apollo-router:
    image: ghcr.io/apollographql/router:latest
    ports:
      - "4000:4000"
    volumes:
      - ./fixtures/supergraph.graphql:/etc/router/supergraph.graphql
      - ./fixtures/router.yaml:/etc/router/router.yaml
    depends_on:
      - flight-service
      - hotel-service
      - car-service
      - payment-service
      - notification-service
    command: --supergraph /etc/router/supergraph.graphql --config /etc/router/router.yaml
